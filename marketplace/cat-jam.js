!async function(){for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var s,l,o,d,c,u,p,e,t,a,r,i,m,f,y,g,n;l=Object.create,o=Object.defineProperty,d=Object.getOwnPropertyDescriptor,c=Object.getOwnPropertyNames,u=Object.getPrototypeOf,p=Object.prototype.hasOwnProperty,a=(e=(e,t)=>function(){return t||(0,e[c(e)[0]])((t={exports:{}}).exports,t),t.exports})({"external-global-plugin:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),r=(t=(e,t,a)=>{a=null!=e?l(u(e)):{};var i=!t&&e&&e.__esModule?a:o(a,"default",{value:e,enumerable:!0}),n=e,s=void 0,r=void 0;if(n&&"object"==typeof n||"function"==typeof n)for(let e of c(n))p.call(i,e)||e===s||o(i,e,{get:()=>n[e],enumerable:!(r=d(n,e))||r.enumerable});return i})(e({"external-global-plugin:react"(e,t){t.exports=Spicetify.React}})()),i=t(a()),m=new class{constructor(e,t,a={}){this.name=e,this.settingsId=t,this.initialSettingsFields=a,this.settingsFields=this.initialSettingsFields,this.setRerender=null,this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!Spicetify?.Platform?.History?.listen;)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()},this.rerender=()=>{this.setRerender&&this.setRerender(Math.random())},this.render=async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}var e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):((t=document.createElement("div")).id=this.settingsId,e.appendChild(t)),i.default.render(r.default.createElement(this.FieldsContainer,null),t)},this.addButton=(e,t,a,i,n)=>{this.settingsFields[e]={type:"button",description:t,value:a,events:{onClick:i,...n}}},this.addInput=(e,t,a,i,n,s)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:a,inputType:n,events:{onChange:i,...s}}},this.addHidden=(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}},this.addToggle=(e,t,a,i,n)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:a,events:{onChange:i,...n}}},this.addDropDown=(e,t,a,i,n,s)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:a[i],options:a,events:{onSelect:n,...s}}},this.getFieldValue=e=>JSON.parse(Spicetify.LocalStorage.get(this.settingsId+"."+e)||"{}")?.value,this.setFieldValue=(e,t)=>{Spicetify.LocalStorage.set(this.settingsId+"."+e,JSON.stringify({value:t}))},this.FieldsContainer=()=>{var[e,t]=(0,r.useState)(0);return this.setRerender=t,r.default.createElement("div",{className:"x-settings-section",key:e},r.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>r.default.createElement(this.Field,{nameId:e,field:t})))},this.Field=a=>{var e=this.settingsId+"."+a.nameId;let t;if(t="button"===a.field.type?a.field.value:this.getFieldValue(a.nameId),"hidden"===a.field.type)return r.default.createElement(r.default.Fragment,null);const[i,n]=(0,r.useState)(t),s=e=>{void 0!==e&&(n(e),this.setFieldValue(a.nameId,e))};return r.default.createElement("div",{className:"x-settings-row"},r.default.createElement("div",{className:"x-settings-firstColumn"},r.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:e},a.field.description||"")),r.default.createElement("div",{className:"x-settings-secondColumn"},"input"===a.field.type?r.default.createElement("input",{className:"x-settings-input",id:e,dir:"ltr",value:i,type:a.field.inputType||"text",...a.field.events,onChange:e=>{s(e.currentTarget.value);var t=a.field.events?.onChange;t&&t(e)}}):"button"===a.field.type?r.default.createElement("span",null,r.default.createElement("button",{id:e,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...a.field.events,onClick:e=>{s();var t=a.field.events?.onClick;t&&t(e)},type:"button"},i)):"toggle"===a.field.type?r.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},r.default.createElement("input",{id:e,className:"x-toggle-input",type:"checkbox",checked:i,...a.field.events,onClick:e=>{s(e.currentTarget.checked);var t=a.field.events?.onClick;t&&t(e)}}),r.default.createElement("span",{className:"x-toggle-indicatorWrapper"},r.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===a.field.type?r.default.createElement("select",{className:"main-dropDown-dropDown",id:e,...a.field.events,onChange:e=>{s(a.field.options[e.currentTarget.selectedIndex]);var t=a.field.events?.onChange;t&&t(e)}},a.field.options.map((e,t)=>r.default.createElement("option",{selected:e===i,value:t+1},e))):r.default.createElement(r.default.Fragment,null)))}}}("Cat-Jam Settings","catjam-settings"),f=null,y={link:"",bpm:135.48,position:"Bottom (Player)",bpmMethod:"Track BPM",bpmMethodFaster:"Track BPM",size:100},g=new Map,n=async function(){for(var e;null==(e=null==Spicetify?void 0:Spicetify.Player)||!e.addEventListener||null==Spicetify||!Spicetify.getAudioData;)await new Promise(e=>setTimeout(e,100));m.addInput("catjam-webm-link","Custom webM video URL",""),m.addInput("catjam-webm-bpm","Custom default BPM",""),m.addDropDown("catjam-webm-position","Position",["Bottom (Player)","Left (Library)"],0),m.addDropDown("catjam-webm-bpm-method","Lowering Method",["Track BPM","Advanced"],0),m.addDropDown("catjam-webm-bpm-method-faster-songs","Faster Method",["Track BPM","Advanced"],0),m.addInput("catjam-webm-position-left-size","Left Size (%)",""),m.addButton("catjam-reload","Reload","Save and reload",()=>{w()}),m.pushSettings(),await w(),Spicetify.Player.addEventListener("onplaypause",()=>{v(performance.now(),Spicetify.Player.getProgress())});let t=0;Spicetify.Player.addEventListener("onprogress",()=>{var e=Spicetify.Player.getProgress();500<=Math.abs(e-t)&&v(performance.now(),e),t=e}),Spicetify.Player.addEventListener("songchange",async()=>{var e,t;f&&(e=performance.now(),s=await b(),f.playbackRate=await h(s),null!=(t=null==s?void 0:s.beats)&&t.length?(t=s.beats[0].start,t=Math.max(0,1e3*t-(performance.now()-e)),setTimeout(()=>null==f?void 0:f.play(),t)):f.play())})},(async()=>{await n()})();async function h(t){var a=y.bpm;if(null!=t&&t.track){t=t.track.tempo;let e=t;a=(e="Track BPM"!==y.bpmMethod?await async function(t){var e=null==(e=null==(e=Spicetify.Player.data)?void 0:e.item)?void 0:e.uri;if(!e)return t;{var a;if(g.has(e))return P((a=g.get(e)).danceability,a.energy,t)}try{var i=e.split(":")[2],n=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/audio-features/"+i),s=Math.round(100*n.danceability),r=Math.round(100*n.energy);return g.set(e,{danceability:s,energy:r}),P(s,r,t)}catch(e){return console.error("[CAT-JAM] Audio features error: ",e),t}}(t):e)?e/a:1;return console.log(`[CAT-JAM] Track BPM: ${t}, Effective BPM: ${e}, Playback Rate: `+a),a}return console.warn("[CAT-JAM] BPM data not available, using default rate."),1}async function b(t=200,a=10){try{return await Spicetify.getAudioData()}catch(e){return"object"==typeof e&&null!==e&&"message"in e&&e.message.includes("Cannot read properties of undefined")&&0<a?(await new Promise(e=>setTimeout(e,t)),b(t,a-1)):(console.warn("[CAT-JAM] Error fetching audio data: "+e),null)}}function v(e,t){if(f)if(Spicetify.Player.isPlaying()){const a=t/1e3;null!=(t=null==s?void 0:s.beats)&&t.length&&(t=s.beats.find(e=>e.start>a))?(e=performance.now()-e,t=Math.max(0,1e3*(t.start-a)-e),setTimeout(()=>{null!=f&&f.play()},t)):f.play()}else f.pause()}async function w(){try{y.link=String(m.getFieldValue("catjam-webm-link")||""),y.bpm=Number(m.getFieldValue("catjam-webm-bpm"))||135.48,y.position=m.getFieldValue("catjam-webm-position"),y.bpmMethod=m.getFieldValue("catjam-webm-bpm-method"),y.bpmMethodFaster=m.getFieldValue("catjam-webm-bpm-method-faster-songs"),y.size=Number(m.getFieldValue("catjam-webm-position-left-size"))||100;var e=`width: ${y.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,t="Bottom (Player)"===y.position,a=t?"width: 65px; height: 65px;":e,i=await async function(t,a=50,i=100){for(let e=0;e<a;e++){var n=document.querySelector(t);if(n)return n;await new Promise(e=>setTimeout(e,i))}throw new Error(`Element ${t} not found.`)}(t?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer"),n=(f&&f.remove(),y.link||"https://github.com/BlafKing/spicetify-cat-jam-synced/raw/main/src/resources/catjam.webm");(f=document.createElement("video")).loop=!0,f.autoplay=!0,f.muted=!0,f.style.cssText=a,f.src=n,f.id="catjam-webm",s=await b(),f.playbackRate=await h(s),i.firstChild?i.insertBefore(f,i.firstChild):i.appendChild(f),Spicetify.Player.isPlaying()?f.play():f.pause()}catch(e){console.error("[CAT-JAM] Initialization error: ",e)}}function P(e,t,a){let i=.9,n=.6,s=.6;var e=e/100,t=t/100,r=a/100,e=(e<.5&&(i*=e),t<.5&&(n*=t),r<.8&&(s=.9),(e*i+t*n+r*s)/(1-i+1-n+s));let l=100*e;return l=l>a?"Track BPM"!==y.bpmMethodFaster?(l+a)/2:a:Math.max(l,70)}}();