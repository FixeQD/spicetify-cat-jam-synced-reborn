var e=(()=>{var e=Object.create,t=Object.defineProperty,a=Object.defineProperties,s=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,l=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,c=(e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s,d=(e,t)=>{for(var a in t||(t={}))o.call(t,a)&&c(e,a,t[a]);if(r)for(var a of r(t))u.call(t,a)&&c(e,a,t[a]);return e},m=(e,t)=>a(e,i(t)),h=(e,t)=>function(){return t||(0,e[n(e)[0]])((t={exports:{}}).exports,t),t.exports},p=(e,a,i,r)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let l of n(a))o.call(e,l)||l===i||t(e,l,{get:()=>a[l],enumerable:!(r=s(a,l))||r.enumerable});return e},f=(a,s,i)=>(i=null!=a?e(l(a)):{},p(!s&&a&&a.__esModule?i:t(i,"default",{value:a,enumerable:!0}),a)),g=(e,t,a)=>c(e,"symbol"!=typeof t?t+"":t,a),y=h({"spicetify-external:react"(e,t){t.exports=Spicetify.React}}),b=h({"spicetify-external:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),v={};((e,a)=>{for(var s in a)t(e,s,{get:a[s],enumerable:!0})})(v,{default:()=>K});var x="catjam-webm",T="Bottom (Player)",S="Left (Library)",w="Track BPM",F="Advanced",R=[.425,.883,1.403,1.841,2.206,2.664,3.075,3.58,3.945,4.433,4.885,5.292,5.826,6.152,7.06,7.51,8.01,8.435,8.86,9.27],P=9.75,k=f(y()),M=f(b()),B={link:{id:"catjam-webm-link",label:"Custom webM video URL",type:"input",default:""},bpm:{id:"catjam-webm-bpm",label:"Custom default BPM",type:"number",default:135.48},position:{id:"catjam-webm-position",label:"Position",type:"dropdown",options:[T,S],default:T},bpmMethod:{id:"catjam-webm-bpm-method",label:"Lowering Method",type:"dropdown",options:[w,F],default:w},bpmMethodFaster:{id:"catjam-webm-bpm-method-faster-songs",label:"Faster Method",type:"dropdown",options:[w,F],default:w},size:{id:"catjam-webm-position-left-size",label:"Left Size (%)",type:"number",default:100}},C=new class{constructor(e,t,a={}){this.name=e,this.settingsId=t,this.initialSettingsFields=a,g(this,"settingsFields",this.initialSettingsFields),g(this,"stopHistoryListener"),g(this,"setRerender",null),g(this,"pushSettings",async()=>{var e,t;for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!(null==(t=null==(e=null==Spicetify?void 0:Spicetify.Platform)?void 0:e.History)?void 0:t.listen);)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()}),g(this,"rerender",()=>{this.setRerender&&this.setRerender(Math.random())}),g(this,"render",async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}const e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):(t=document.createElement("div"),t.id=this.settingsId,e.appendChild(t)),M.default.render(k.default.createElement(this.FieldsContainer,null),t)}),g(this,"addButton",(e,t,a,s,i)=>{this.settingsFields[e]={type:"button",description:t,value:a,events:d({onClick:s},i)}}),g(this,"addInput",(e,t,a,s,i,n)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:a,inputType:i,events:d({onChange:s},n)}}),g(this,"addHidden",(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}}),g(this,"addToggle",(e,t,a,s,i)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:a,events:d({onChange:s},i)}}),g(this,"addDropDown",(e,t,a,s,i,n)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:a[s],options:a,events:d({onSelect:i},n)}}),g(this,"getFieldValue",e=>{var t;return null==(t=JSON.parse(Spicetify.LocalStorage.get(`${this.settingsId}.${e}`)||"{}"))?void 0:t.value}),g(this,"setFieldValue",(e,t)=>{Spicetify.LocalStorage.set(`${this.settingsId}.${e}`,JSON.stringify({value:t}))}),g(this,"FieldsContainer",()=>{const[e,t]=(0,k.useState)(0);return this.setRerender=t,k.default.createElement("div",{className:"x-settings-section",key:e},k.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>k.default.createElement(this.Field,{nameId:e,field:t})))}),g(this,"Field",e=>{const t=`${this.settingsId}.${e.nameId}`;let a;if(a="button"===e.field.type?e.field.value:this.getFieldValue(e.nameId),"hidden"===e.field.type)return k.default.createElement(k.default.Fragment,null);const[s,i]=(0,k.useState)(a),n=t=>{void 0!==t&&(i(t),this.setFieldValue(e.nameId,t))};return k.default.createElement("div",{className:"x-settings-row"},k.default.createElement("div",{className:"x-settings-firstColumn"},k.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:t},e.field.description||"")),k.default.createElement("div",{className:"x-settings-secondColumn"},"input"===e.field.type?k.default.createElement("input",m(d({className:"x-settings-input",id:t,dir:"ltr",value:s,type:e.field.inputType||"text"},e.field.events),{onChange:t=>{var a;n(t.currentTarget.value);const s=null==(a=e.field.events)?void 0:a.onChange;s&&s(t)}})):"button"===e.field.type?k.default.createElement("span",null,k.default.createElement("button",m(d({id:t,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button"},e.field.events),{onClick:t=>{var a;n();const s=null==(a=e.field.events)?void 0:a.onClick;s&&s(t)},type:"button"}),s)):"toggle"===e.field.type?k.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},k.default.createElement("input",m(d({id:t,className:"x-toggle-input",type:"checkbox",checked:s},e.field.events),{onClick:t=>{var a;n(t.currentTarget.checked);const s=null==(a=e.field.events)?void 0:a.onClick;s&&s(t)}})),k.default.createElement("span",{className:"x-toggle-indicatorWrapper"},k.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===e.field.type?k.default.createElement("select",m(d({className:"main-dropDown-dropDown",id:t},e.field.events),{onChange:t=>{var a;n(e.field.options[t.currentTarget.selectedIndex]);const s=null==(a=e.field.events)?void 0:a.onChange;s&&s(t)}}),e.field.options.map((e,t)=>k.default.createElement("option",{selected:e===s,value:t+1},e))):k.default.createElement(k.default.Fragment,null)))})}}("Cat-Jam Settings","catjam-settings"),O=new Proxy({},{get:(e,t)=>{const a=B[t];if(!a)return;const s=C.getFieldValue(a.id);if(null==s||""===s)return a.default;if("number"===a.type){const e=Number(s);return isNaN(e)?a.default:e}return s}}),E=null;function D(){return E}function L(e){E=e}async function j(e=200,t=10){var a,s;const i=null==(s=null==(a=Spicetify.Player.data)?void 0:a.item)?void 0:s.uri;if(!i)return null;try{const e=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${i.split(":")[2]}?format=json`,t=await Spicetify.CosmosAsync.get(e);return L(t),t}catch(a){console.warn(`[CAT-JAM] Error fetching detailed analysis: ${a}`);try{const e=await Spicetify.getAudioData();return L(e),e}catch(a){return t>0?(await new Promise(t=>setTimeout(t,e)),j(e,t-1)):null}}}var I={high:{lerpFactor:.1,maxDelta:.025,snapThreshold:.04,velocityWeight:.35,maxDriftCorrection:.2,aggressiveSnapThreshold:.02,minStableFrames:3},medium:{lerpFactor:.06,maxDelta:.018,snapThreshold:.06,velocityWeight:.28,maxDriftCorrection:.15,aggressiveSnapThreshold:.03,minStableFrames:4},low:{lerpFactor:.04,maxDelta:.012,snapThreshold:.08,velocityWeight:.22,maxDriftCorrection:.12,aggressiveSnapThreshold:.04,minStableFrames:5}},_=new class{constructor(){this.state={playbackRate:1,currentBeatIndex:-1,lastBeatTime:0,expectedVideoTime:0,drift:0},this.velocityHistory=[],this.velocityHistorySize=5}reset(){this.state={playbackRate:1,currentBeatIndex:-1,lastBeatTime:0,expectedVideoTime:0,drift:0},this.velocityHistory=[]}update(e,t,a,s="high"){var i,n;if(!(null==(i=null==a?void 0:a.beats)?void 0:i.length))return{playbackRate:1,shouldSnap:!1};const r=null!=(n=I[s])?n:I.high,l=a.beats;let o=this.findCurrentBeat(e,l);o<0&&(o=0);const u=this.findNextBeat(e,l);if(!u)return{playbackRate:this.state.playbackRate,shouldSnap:!1};o!==this.state.currentBeatIndex&&this.state.currentBeatIndex>=0&&this.onBeatTransition(o,e,r),this.state.currentBeatIndex=o;const{targetRate:c,timeUntilBeat:d,timeUntilDrop:m}=this.calculateTargetRate(e,t,u,l);if(d<=r.snapThreshold){const a=this.handleBeatSnap(e,t,u,l,o,r);return{playbackRate:a.playbackRate,shouldSnap:a.shouldSnap,snapTime:a.snapTime,needsReset:a.needsReset}}const h=this.calculateVelocityPrediction(c,s),p=this.clampTargetRate(c,r);return this.state.playbackRate=this.smoothTransition(this.state.playbackRate,p,r,h),this.state.drift=this.calculateDrift(t,e,u,l,o),{playbackRate:this.state.playbackRate,shouldSnap:!1}}findCurrentBeat(e,t){for(let a=t.length-1;a>=0;a--)if(t[a].start<=e)return a;return-1}findNextBeat(e,t){for(let a=0;a<t.length;a++)if(t[a].start>e)return{index:a,time:t[a].start};return null}getNextHeadDrop(e){const t=R;for(let a=0;a<t.length;a++)if(t[a]>e)return{index:a,time:t[a]};return{index:0,time:t[0]+9.75}}calculateTargetRate(e,t,a,s){const i=R,n=P,r=this.getNextHeadDrop(t);let l;l=r.time<n?r.time-t:n-t+i[0];const o=this.findCurrentBeat(e,s),u=o>=0&&o<s.length-1?s[o+1].start-s[o].start:1,c=a.time-e,d=l*(c/u);return{targetRate:d>0?d/c:1,timeUntilBeat:c,timeUntilDrop:d}}handleBeatSnap(e,t,a,s,i,n){var r;const l=R,o=P,u=a.index%l.length,c=l[u],d=l[(u+1)%l.length];let m;m=d>c?d-c:o-c+d;const h=c+(e-s[i].start)/m*m,p=h>=o?h-o:h;let f=(t>=o?t-o:t)-p;Math.abs(f)>4.875&&(f=f>0?f-o:f+o);const g=Math.abs(f),y=n.maxDriftCorrection,b=null!=(r=n.aggressiveSnapThreshold)?r:.02;let v=1;if(g>1.5)return this.state.playbackRate=1,{playbackRate:1,shouldSnap:!0,snapTime:p,needsReset:!0};if(g>y){const e=g>b?.15:.1;v=f>0?1-Math.min(g*e,.2):1+Math.min(g*e,.2)}const x=g>y?.25:.15;return this.state.playbackRate=this.lerp(this.state.playbackRate,v,x),{playbackRate:this.clamp(this.state.playbackRate,.85,1.3),shouldSnap:!0,snapTime:p,needsReset:!1}}onBeatTransition(e,t,a){if(this.state.lastBeatTime>0){const e=t-this.state.lastBeatTime;if(e>0){const t=(this.state.playbackRate-1)/e;this.velocityHistory.push(t),this.velocityHistory.length>this.velocityHistorySize&&this.velocityHistory.shift()}}this.state.lastBeatTime=t}calculateVelocityPrediction(e,t){var a;return this.velocityHistory.length<2?0:this.velocityHistory.reduce((e,t)=>e+t,0)/this.velocityHistory.length*(null!=(a=I[t])?a:I.high).velocityWeight}calculateDrift(e,t,a,s,i){const n=R,r=P;if(i<0||i>=s.length)return 0;const l=a.index%n.length,o=n[l],u=n[(l+1)%n.length];let c;c=u>o?u-o:r-o+u;const d=i<s.length-1?s[i+1].start-s[i].start:1,m=t-s[i].start;let h=o+Math.min(1,m/d)*c;return h>=r&&(h-=r),e-h}smoothTransition(e,t,a,s){const i=t+s,n=this.clamp(i,.85,1.3);return this.lerp(e,n,a.lerpFactor)}clampTargetRate(e,t){return this.clamp(e,.85,1.3)}clamp(e,t,a){return Math.max(t,Math.min(a,e))}lerp(e,t,a){return e+(t-e)*a}getState(){return d({},this.state)}},A=null;function N(){return A}function H(e,t){var a;if(A)if(Spicetify.Player.isPlaying()){_.reset();const s=t/1e3,i=D();if(null==(a=null==i?void 0:i.beats)?void 0:a.length){const t=i.beats.find(e=>e.start>s);if(t){const a=performance.now()-e,i=Math.max(0,1e3*(t.start-s)-a);setTimeout(()=>{null==A||A.play()},i)}else A.play()}else A.play()}else A.pause()}async function V(){try{const e=O.position===T,t=P,a=`width: ${O.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,s=e?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer",i=e?"width: 65px; height: 65px;":a,n=await async function(e,t=50,a=100){for(let s=0;s<t;s++){const t=document.querySelector(e);if(t)return t;await new Promise(e=>setTimeout(e,a))}throw new Error(`Element ${e} not found.`)}(s);if(A){A.remove();const e=document.getElementById(x);e&&e.remove()}const r=O.link||"https://github.com/FixeQD/spicetify-cat-jam-synced-reborn/raw/main/src/resources/catjam.webm";(A=document.createElement("video")).loop=!1,A.autoplay=!1,A.muted=!0,A.style.cssText=i,A.src=r,A.id=x;const l=t-.15,o=()=>{A&&A.currentTime>=l&&(A.currentTime=0)},u=()=>{A&&(A.currentTime=0,A.play())};A.addEventListener("timeupdate",o),A.addEventListener("ended",u),await j(),A.playbackRate=1,_.reset(),n.firstChild?n.insertBefore(A,n.firstChild):n.appendChild(A),_.reset(),Spicetify.Player.isPlaying()?A.play():A.pause()}catch(e){console.error("[CAT-JAM] Initialization error: ",e)}}var z=new class{constructor(){this.frameTimes=[],this.lastFrameTime=0,this.frameCount=0,this.fpsUpdateTime=0,this.currentFPS=60,this.droppedFrames=0,this.measurementWindowMs=1e3,this.samplesCount=30}getPerformanceLevel(){return this.currentFPS<30?"low":this.currentFPS<50?"medium":"high"}getMetrics(){return{level:this.getPerformanceLevel(),fps:this.currentFPS,frameTime:this.lastFrameTime,droppedFrames:this.droppedFrames,avgFrameTime:this.getAverageFrameTime()}}measureFrame(){const e=performance.now();if(this.lastFrameTime>0){const t=e-this.lastFrameTime;this.frameTimes.push(t),t>33.33&&this.droppedFrames++,this.frameTimes.length>this.samplesCount&&this.frameTimes.shift()}this.lastFrameTime=e,this.frameCount++,e-this.fpsUpdateTime>=this.measurementWindowMs&&(this.currentFPS=1e3*this.frameCount/(e-this.fpsUpdateTime),this.frameCount=0,this.fpsUpdateTime=e)}getAverageFrameTime(){return 0===this.frameTimes.length?16.67:this.frameTimes.reduce((e,t)=>e+t,0)/this.frameTimes.length}getThrottleInterval(){const e=this.getPerformanceLevel();return"low"===e?33.33:"medium"===e?16.67:0}shouldSkipFrame(){const e=this.getThrottleInterval();return 0!==e&&this.lastFrameTime>0&&this.lastFrameTime<e}reset(){this.frameTimes=[],this.lastFrameTime=0,this.frameCount=0,this.fpsUpdateTime=0,this.currentFPS=60,this.droppedFrames=0}},$={maxBufferSize:8,maxAgeMs:100,interpolationThreshold:.02,maxJumpRate:.15,smoothFactor:.3},U=class{constructor(e=$){this.config=e,this.buffer=[],this.lastOutputRate=1,this.lastOutputTime=0}setConfig(e){this.config=e}push(e,t=performance.now()){this.buffer.push({rate:e,timestamp:t});const a=performance.now();for(this.buffer=this.buffer.filter(e=>a-e.timestamp<this.config.maxAgeMs);this.buffer.length>this.config.maxBufferSize;)this.buffer.shift()}getOutput(e=performance.now()){if(0===this.buffer.length)return{rate:this.lastOutputRate,isBuffered:!1,shouldSkip:!1};const t=this.buffer[this.buffer.length-1];if(1===this.buffer.length)return this.applyBufferLogic(t.rate,t.timestamp,e);const a=this.buffer[0];if(e-a.timestamp>this.config.maxAgeMs)return this.buffer.shift(),this.getOutput(e);const s=this.interpolate(a,t,e);return this.applyBufferLogic(s,a.timestamp,e)}interpolate(e,t,a){const s=t.timestamp-e.timestamp;if(s<=0)return t.rate;const i=a-e.timestamp,n=Math.min(1,Math.max(0,i/s));return e.rate+(t.rate-e.rate)*this.easeInOut(n)}easeInOut(e){return e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2}applyBufferLogic(e,t,a){const s=Math.abs(e-this.lastOutputRate),i=a-t<50,n=this.buffer.length>1;if(i&&n&&s>this.config.interpolationThreshold){const t=this.lerp(this.lastOutputRate,e,this.config.smoothFactor);return s>this.config.maxJumpRate?{rate:this.lastOutputRate,isBuffered:!0,shouldSkip:!0}:(this.lastOutputRate=t,this.lastOutputTime=a,{rate:t,isBuffered:!0,shouldSkip:!1})}return this.lastOutputRate=e,this.lastOutputTime=a,{rate:e,isBuffered:n,shouldSkip:!1}}lerp(e,t,a){return e+(t-e)*a}clear(){this.buffer=[],this.lastOutputRate=1}getBufferSize(){return this.buffer.length}isStale(e=performance.now()){return 0===this.buffer.length||e-this.lastOutputTime>this.config.maxAgeMs}},J=new U($),W=new U({maxBufferSize:6,maxAgeMs:80,interpolationThreshold:.03,maxJumpRate:.12,smoothFactor:.25}),q=new U({maxBufferSize:4,maxAgeMs:60,interpolationThreshold:.05,maxJumpRate:.1,smoothFactor:.2});function Q(e){return"low"===e?q:"medium"===e?W:J}async function X(){var e;for(console.log("[CAT-JAM] Extension initializing...");!(null==(e=null==Spicetify?void 0:Spicetify.Player)?void 0:e.addEventListener)||!(null==Spicetify?void 0:Spicetify.getAudioData);)await new Promise(e=>setTimeout(e,100));Object.values(B).forEach(e=>{"input"===e.type||"number"===e.type?C.addInput(e.id,e.label,String(e.default)):"dropdown"===e.type&&C.addDropDown(e.id,e.label,e.options,0)}),C.addButton("catjam-reload","Reload","Save and reload",()=>{V()}),C.pushSettings(),await V();let t=null,a=null,s=!1;try{const e=new Blob([`(${(()=>{const e=R;let t=1,a=-1;self.onmessage=s=>{const{type:i,data:n}=s.data;if("process"===i&&n.audioData){const s=function(s,i,n="high"){const r=s/1e3,{lerp:l,maxDelta:o}=function(e){return"low"===e?{lerp:.03,maxDelta:.01}:"medium"===e?{lerp:.05,maxDelta:.015}:{lerp:.08,maxDelta:.02}}(n),u=function(s,i,n=.08){var r;if(!(null==(r=null==i?void 0:i.beats)?void 0:r.length))return 1;let l=-1;for(let e=0;e<i.beats.length&&i.beats[e].start<=s;e++)l=e;l!==a&&(a=l);const o=function(e,t){for(let a=0;a<t.length;a++)if(t[a].start>e)return{index:a,time:t[a].start};return null}(s,i.beats);if(!o)return 1;const u=o.index%e.length,c=e[u],d=e[(u+1)%e.length];let m;m=d>c?d-c:9.75-c+d;const h=o.time-s;if(h<=.05)return t;const p=m*(h/(i.beats[o.index].start-i.beats[l].start))/h,f=Math.max(.85,Math.min(1.3,p));return t=(g=t)+(f-g)*n,Math.abs(t-f),t;var g}(r,i,l),c=function(e,t){var a,s;if(!e||0===e.length)return-60;let i=0,n=e.length-1,r=0;for(;i<=n;){r=i+n>>1;const a=e[r];if(a.start<=t&&a.start+a.duration>t)break;a.start>t?n=r-1:i=r+1}const l=e[r];if(!l)return-60;const o=t-l.start,u=l.loudness_max_time;if(o<u){const e=o/u;return l.loudness_start+e*(l.loudness_max-l.loudness_start)}{const t=(o-u)/(l.duration-u),i=null!=(s=null==(a=e[r+1])?void 0:a.loudness_start)?s:l.loudness_max;return l.loudness_max+t*(i-l.loudness_max)}}(i.segments,r);return{playbackRate:u,scale:1+Math.max(0,Math.min(1,(c+60)/60))*(1.15-1)}}(n.progressMs,n.audioData,n.perfLevel);self.postMessage({type:"result",data:s})}"resetRate"===i&&(t=1,a=-1)}}).toString()})()`],{type:"application/javascript"});a=new Worker(URL.createObjectURL(e)),s=!0,a.onmessage=e=>{const{type:t,data:a}=e.data;if("result"===t&&N()){const e=N(),t=Q(z.getPerformanceLevel());t.push(a.playbackRate,performance.now());const s=t.getOutput();s.shouldSkip||(e.playbackRate=s.rate),e.style.transform=`scale(${a.scale})`}}}catch(e){console.warn("[CAT-JAM] Worker setup failed, falling back to main thread:",e),a=null}const i=(n=async e=>{var n;if(!Spicetify.Player.isPlaying())return t=null,void(null==(n=N())||n.pause());const r=Spicetify.Player.getProgress(),l=z.getPerformanceLevel();if(a&&s){const e=D();e&&a.postMessage({type:"process",data:{progressMs:r,audioData:e,perfLevel:l}})}else{!function(e,t="high"){if(!A)return;const a=function(e,t="high"){var a;if(!A)return 1;const s=D();if(!(null==(a=null==s?void 0:s.beats)?void 0:a.length))return 1;const i=e/1e3,n=A.currentTime,r=_.update(i,n,s,t);if(r.needsReset){const e=P;if(void 0!==r.snapTime){let t=n;t>=e&&(t-=e);const a=t-r.snapTime;Math.abs(a)>1.5&&(A.currentTime=r.snapTime)}return _.reset(),1}if(r.shouldSnap&&void 0!==r.snapTime){let e=n;e>=P&&(e-=P);const t=e-r.snapTime;if(Math.abs(t)>1.5)return A.currentTime=r.snapTime,_.reset(),1}return r.playbackRate}(e,t);A.playbackRate=a}(r,l);const{loudness:e}=function(e){var t;if(!E)return{playbackRate:1,loudness:.5};const a=e/1e3,s=O.bpm,i=function(e,t,a=6){if(!e||e.length<2)return 0;const s=t-a/2,i=t+a/2,n=e.filter(e=>e.start>=s&&e.start<=i);return n.length<2?0:60/((n[n.length-1].start-n[0].start)/(n.length-1))}(E.beats,a)||(null==(t=E.track)?void 0:t.tempo)||s,n=(r=function(e,t){var a,s;if(!e||0===e.length)return-60;let i=0,n=e.length-1,r=0;for(;i<=n;){r=i+n>>1;const a=e[r];if(a.start<=t&&a.start+a.duration>t)break;a.start>t?n=r-1:i=r+1}const l=e[r];if(!l)return-60;const o=t-l.start,u=l.loudness_max_time;if(o<u){const e=o/u;return l.loudness_start+e*(l.loudness_max-l.loudness_start)}{const t=(o-u)/(l.duration-u),i=null!=(s=null==(a=e[r+1])?void 0:a.loudness_start)?s:l.loudness_max;return l.loudness_max+t*(i-l.loudness_max)}}(E.segments,a),Math.max(0,Math.min(1,(r- -60)/60)));var r;return{playbackRate:i/s,loudness:n,bpm:i}}(r),t=N();if(t){const a=1+e*(1.15-1);t.style.transform=`scale(${a})`}}t=requestAnimationFrame(i)},e=>{z.measureFrame(),z.shouldSkipFrame()||n()});var n;const r=()=>{t||(t=requestAnimationFrame(i))};Spicetify.Player.addEventListener("onplaypause",()=>{const e=Spicetify.Player.getProgress();H(performance.now(),e),Spicetify.Player.isPlaying()?r():(null==a||a.postMessage({type:"resetRate"}),Q("high").clear(),Q("medium").clear(),Q("low").clear())});let l=0;Spicetify.Player.addEventListener("onprogress",()=>{const e=Spicetify.Player.getProgress();Math.abs(e-l)>=500&&H(performance.now(),e),l=e}),Spicetify.Player.addEventListener("songchange",async()=>{var e;const t=N();if(!t)return;Q("high").clear(),Q("medium").clear(),Q("low").clear();const a=performance.now(),s=await j();if(t.playbackRate=1,null==(e=null==s?void 0:s.beats)?void 0:e.length){const e=s.beats[0].start,t=Math.max(0,1e3*e-(performance.now()-a));setTimeout(()=>{var e;null==(e=N())||e.play(),r()},t)}else t.play(),r()}),Spicetify.Player.isPlaying()&&r()}var G,K=X;return X(),G=v,p(t({},"__esModule",{value:!0}),G)})();