var e=(()=>{var e=Object.create,t=Object.defineProperty,n=Object.defineProperties,i=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,l=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,u=(e,n,i)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i,c=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&u(e,n,t[n]);if(r)for(var n of r(t))d.call(t,n)&&u(e,n,t[n]);return e},f=(e,t)=>n(e,a(t)),p=(e,t)=>function(){return t||(0,e[s(e)[0]])((t={exports:{}}).exports,t),t.exports},m=(e,n,a,r)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let l of s(n))o.call(e,l)||l===a||t(e,l,{get:()=>n[l],enumerable:!(r=i(n,l))||r.enumerable});return e},y=(n,i,a)=>(a=null!=n?e(l(n)):{},m(!i&&n&&n.__esModule?a:t(a,"default",{value:n,enumerable:!0}),n)),h=(e,t,n)=>u(e,"symbol"!=typeof t?t+"":t,n),g=p({"spicetify-external:react"(e,t){t.exports=Spicetify.React}}),b=p({"spicetify-external:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),v={};((e,n)=>{for(var i in n)t(e,i,{get:n[i],enumerable:!0})})(v,{default:()=>z});var w="Bottom (Player)",S="Left (Library)",x="Track BPM",P="Advanced",E=[.425,.883,1.403,1.841,2.206,2.664,3.075,3.58,3.945,4.433,4.885,5.292,5.826,6.152,7.06,7.51,8.01,8.435,8.86,9.27],F=y(g()),C=y(b()),j={link:{id:"catjam-webm-link",label:"Custom webM video URL",type:"input",default:""},bpm:{id:"catjam-webm-bpm",label:"Custom default BPM",type:"number",default:135.48},position:{id:"catjam-webm-position",label:"Position",type:"dropdown",options:[w,S],default:w},bpmMethod:{id:"catjam-webm-bpm-method",label:"Lowering Method",type:"dropdown",options:[x,P],default:x},bpmMethodFaster:{id:"catjam-webm-bpm-method-faster-songs",label:"Faster Method",type:"dropdown",options:[x,P],default:x},size:{id:"catjam-webm-position-left-size",label:"Left Size (%)",type:"number",default:100}},M=new class{constructor(e,t,n={}){this.name=e,this.settingsId=t,this.initialSettingsFields=n,h(this,"settingsFields",this.initialSettingsFields),h(this,"stopHistoryListener"),h(this,"setRerender",null),h(this,"pushSettings",async()=>{var e,t;for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!(null==(t=null==(e=null==Spicetify?void 0:Spicetify.Platform)?void 0:e.History)?void 0:t.listen);)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()}),h(this,"rerender",()=>{this.setRerender&&this.setRerender(Math.random())}),h(this,"render",async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}const e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):(t=document.createElement("div"),t.id=this.settingsId,e.appendChild(t)),C.default.render(F.default.createElement(this.FieldsContainer,null),t)}),h(this,"addButton",(e,t,n,i,a)=>{this.settingsFields[e]={type:"button",description:t,value:n,events:c({onClick:i},a)}}),h(this,"addInput",(e,t,n,i,a,s)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:n,inputType:a,events:c({onChange:i},s)}}),h(this,"addHidden",(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}}),h(this,"addToggle",(e,t,n,i,a)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:n,events:c({onChange:i},a)}}),h(this,"addDropDown",(e,t,n,i,a,s)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:n[i],options:n,events:c({onSelect:a},s)}}),h(this,"getFieldValue",e=>{var t;return null==(t=JSON.parse(Spicetify.LocalStorage.get(`${this.settingsId}.${e}`)||"{}"))?void 0:t.value}),h(this,"setFieldValue",(e,t)=>{Spicetify.LocalStorage.set(`${this.settingsId}.${e}`,JSON.stringify({value:t}))}),h(this,"FieldsContainer",()=>{const[e,t]=(0,F.useState)(0);return this.setRerender=t,F.default.createElement("div",{className:"x-settings-section",key:e},F.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>F.default.createElement(this.Field,{nameId:e,field:t})))}),h(this,"Field",e=>{const t=`${this.settingsId}.${e.nameId}`;let n;if(n="button"===e.field.type?e.field.value:this.getFieldValue(e.nameId),"hidden"===e.field.type)return F.default.createElement(F.default.Fragment,null);const[i,a]=(0,F.useState)(n),s=t=>{void 0!==t&&(a(t),this.setFieldValue(e.nameId,t))};return F.default.createElement("div",{className:"x-settings-row"},F.default.createElement("div",{className:"x-settings-firstColumn"},F.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:t},e.field.description||"")),F.default.createElement("div",{className:"x-settings-secondColumn"},"input"===e.field.type?F.default.createElement("input",f(c({className:"x-settings-input",id:t,dir:"ltr",value:i,type:e.field.inputType||"text"},e.field.events),{onChange:t=>{var n;s(t.currentTarget.value);const i=null==(n=e.field.events)?void 0:n.onChange;i&&i(t)}})):"button"===e.field.type?F.default.createElement("span",null,F.default.createElement("button",f(c({id:t,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button"},e.field.events),{onClick:t=>{var n;s();const i=null==(n=e.field.events)?void 0:n.onClick;i&&i(t)},type:"button"}),i)):"toggle"===e.field.type?F.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},F.default.createElement("input",f(c({id:t,className:"x-toggle-input",type:"checkbox",checked:i},e.field.events),{onClick:t=>{var n;s(t.currentTarget.checked);const i=null==(n=e.field.events)?void 0:n.onClick;i&&i(t)}})),F.default.createElement("span",{className:"x-toggle-indicatorWrapper"},F.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===e.field.type?F.default.createElement("select",f(c({className:"main-dropDown-dropDown",id:t},e.field.events),{onChange:t=>{var n;s(e.field.options[t.currentTarget.selectedIndex]);const i=null==(n=e.field.events)?void 0:n.onChange;i&&i(t)}}),e.field.options.map((e,t)=>F.default.createElement("option",{selected:e===i,value:t+1},e))):F.default.createElement(F.default.Fragment,null)))})}}("Cat-Jam Settings","catjam-settings"),T=new Proxy({},{get:(e,t)=>{const n=j[t];if(!n)return;const i=M.getFieldValue(n.id);if(null==i||""===i)return n.default;if("number"===n.type){const e=Number(i);return isNaN(e)?n.default:e}return i}}),O=null;function k(){return O}function N(e){O=e}async function I(e=200,t=10){var n,i;const a=null==(i=null==(n=Spicetify.Player.data)?void 0:n.item)?void 0:i.uri;if(!a)return null;try{const e=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${a.split(":")[2]}?format=json`,t=await Spicetify.CosmosAsync.get(e);return N(t),t}catch(n){console.warn(`[CAT-JAM] Error fetching detailed analysis: ${n}`);try{const e=await Spicetify.getAudioData();return N(e),e}catch(n){return t>0?(await new Promise(t=>setTimeout(t,e)),I(e,t-1)):null}}}var L=null,_=-1,A=1;function D(){return L}function R(e){var t;if(!L)return;const n=k();if(!(null==(t=null==n?void 0:n.beats)?void 0:t.length))return;const i=e/1e3,a=E,s=9.75;let r=0;for(let e=0;e<n.beats.length&&n.beats[e].start<=i;e++)r=e;if(r===_)return;_=r;const l=n.beats[r],o=n.beats[r+1];if(!l||!o)return;const d=o.start-l.start,u=i-l.start,c=Math.min(1,u/d),f=r%a.length,p=a[f],m=a[(f+1)%a.length];let y;y=m>p?m-p:s-p+m;let h=p+c*y;h>=s&&(h-=s);const g=Math.abs(L.currentTime-h);Math.min(g,s-g)>.3&&(L.currentTime=h)}function B(e,t){var n;if(L)if(Spicetify.Player.isPlaying()){_=-1,R(t);const i=t/1e3,a=k();if(null==(n=null==a?void 0:a.beats)?void 0:n.length){const t=a.beats.find(e=>e.start>i);if(t){const n=performance.now()-e,a=Math.max(0,1e3*(t.start-i)-n);setTimeout(()=>{null==L||L.play()},a)}else L.play()}else L.play()}else L.pause()}async function V(){try{const e=T.position===w,t=`width: ${T.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,n=e?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer",i=e?"width: 65px; height: 65px;":t,a=await async function(e,t=50,n=100){for(let i=0;i<t;i++){const t=document.querySelector(e);if(t)return t;await new Promise(e=>setTimeout(e,n))}throw new Error(`Element ${e} not found.`)}(n);L&&L.remove();const s=T.link||"https://github.com/FixeQD/spicetify-cat-jam-synced-reborn/raw/main/src/resources/catjam.webm";(L=document.createElement("video")).loop=!0,L.autoplay=!1,L.muted=!0,L.style.cssText=i,L.src=s,L.id="catjam-webm",await I(),L.playbackRate=1,A=1,a.firstChild?a.insertBefore(L,a.firstChild):a.appendChild(L),_=-1,A=1,Spicetify.Player.isPlaying()?L.play():L.pause()}catch(e){console.error("[CAT-JAM] Initialization error: ",e)}}async function $(){var e;for(console.log("[CAT-JAM] Extension initializing...");!(null==(e=null==Spicetify?void 0:Spicetify.Player)?void 0:e.addEventListener)||!(null==Spicetify?void 0:Spicetify.getAudioData);)await new Promise(e=>setTimeout(e,100));Object.values(j).forEach(e=>{"input"===e.type||"number"===e.type?M.addInput(e.id,e.label,String(e.default)):"dropdown"===e.type&&M.addDropDown(e.id,e.label,e.options,0)}),M.addButton("catjam-reload","Reload","Save and reload",()=>{V()}),M.pushSettings(),await V();let t=null;const n=async()=>{var e;if(!Spicetify.Player.isPlaying())return t=null,void(null==(e=D())||e.pause());const i=Spicetify.Player.getProgress();!function(e){if(!L)return;R(e);const t=function(e){var t;if(!L)return 1;const n=k();if(!(null==(t=null==n?void 0:n.beats)?void 0:t.length))return 1;const i=e/1e3,a=L.currentTime,s=function(e,t){for(let n=0;n<t.length;n++)if(t[n].start>e)return{index:n,time:t[n].start};return null}(i,n.beats);if(!s)return 1;const r=function(e){const t=E;for(let n=0;n<t.length;n++)if(t[n]>e)return{index:n,time:t[n]};return{index:0,time:t[0]+9.75}}(a),l=s.time-i;if(l<=.05)return A;let o=r.time-a;o<=0&&(o+=9.75);const d=o/l,u=Math.max(.7,Math.min(1.5,d));var c;return A=(c=A)+.15*(u-c)}(e);L.playbackRate=t}(i);const{loudness:a}=function(e){var t;if(!O)return{playbackRate:1,loudness:.5};const n=e/1e3,i=T.bpm,a=function(e,t,n=6){if(!e||e.length<2)return 0;const i=t-n/2,a=t+n/2,s=e.filter(e=>e.start>=i&&e.start<=a);return s.length<2?0:60/((s[s.length-1].start-s[0].start)/(s.length-1))}(O.beats,n)||(null==(t=O.track)?void 0:t.tempo)||i,s=(r=function(e,t){var n,i;if(!e||0===e.length)return-60;let a=0,s=e.length-1,r=0;for(;a<=s;){r=a+s>>1;const n=e[r];if(n.start<=t&&n.start+n.duration>t)break;n.start>t?s=r-1:a=r+1}const l=e[r];if(!l)return-60;const o=t-l.start,d=l.loudness_max_time;if(o<d){const e=o/d;return l.loudness_start+e*(l.loudness_max-l.loudness_start)}{const t=(o-d)/(l.duration-d),a=null!=(i=null==(n=e[r+1])?void 0:n.loudness_start)?i:l.loudness_max;return l.loudness_max+t*(a-l.loudness_max)}}(O.segments,n),Math.max(0,Math.min(1,(r- -60)/60)));var r;return{playbackRate:a/i,loudness:s,bpm:a}}(i),s=D();if(s){const e=1+a*(1.15-1);s.style.transform=`scale(${e})`}t=requestAnimationFrame(n)},i=()=>{t||(t=requestAnimationFrame(n))};Spicetify.Player.addEventListener("onplaypause",()=>{const e=Spicetify.Player.getProgress();B(performance.now(),e),Spicetify.Player.isPlaying()&&i()});let a=0;Spicetify.Player.addEventListener("onprogress",()=>{const e=Spicetify.Player.getProgress();Math.abs(e-a)>=500&&B(performance.now(),e),a=e}),Spicetify.Player.addEventListener("songchange",async()=>{var e;const t=D();if(!t)return;const n=performance.now(),a=await I();if(t.playbackRate=1,null==(e=null==a?void 0:a.beats)?void 0:e.length){const e=a.beats[0].start,t=Math.max(0,1e3*e-(performance.now()-n));setTimeout(()=>{var e;null==(e=D())||e.play(),i()},t)}else t.play(),i()}),Spicetify.Player.isPlaying()&&i()}var H,z=$;return $(),H=v,m(t({},"__esModule",{value:!0}),H)})();