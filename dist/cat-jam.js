var t=(()=>{var t=Object.create,e=Object.defineProperty,n=Object.defineProperties,i=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,o=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,c=(t,n,i)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i,d=(t,e)=>{for(var n in e||(e={}))l.call(e,n)&&c(t,n,e[n]);if(s)for(var n of s(e))u.call(e,n)&&c(t,n,e[n]);return t},p=(t,e)=>n(t,a(e)),f=(t,e)=>function(){return e||(0,t[r(t)[0]])((e={exports:{}}).exports,e),e.exports},m=(t,n,a,s)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let o of r(n))l.call(t,o)||o===a||e(t,o,{get:()=>n[o],enumerable:!(s=i(n,o))||s.enumerable});return t},h=(n,i,a)=>(a=null!=n?t(o(n)):{},m(!i&&n&&n.__esModule?a:e(a,"default",{value:n,enumerable:!0}),n)),g=(t,e,n)=>c(t,"symbol"!=typeof e?e+"":e,n),y=f({"spicetify-external:react"(t,e){e.exports=Spicetify.React}}),b=f({"spicetify-external:react-dom"(t,e){e.exports=Spicetify.ReactDOM}}),v={};((t,n)=>{for(var i in n)e(t,i,{get:n[i],enumerable:!0})})(v,{default:()=>pt});var x="catjam-webm",w="Bottom (Player)",S="Left (Library)",T="Track BPM",F="Advanced",M=[.425,.883,1.403,1.841,2.206,2.664,3.075,3.58,3.945,4.433,4.885,5.292,5.826,6.152,7.06,7.51,8.01,8.435,8.86,9.27],k=9.75,P=h(y()),R=h(b()),E={link:{id:"catjam-webm-link",label:"Custom webM video URL",type:"input",default:""},bpm:{id:"catjam-webm-bpm",label:"Custom default BPM",type:"number",default:135.48},position:{id:"catjam-webm-position",label:"Position",type:"dropdown",options:[w,S],default:w},bpmMethod:{id:"catjam-webm-bpm-method",label:"Lowering Method",type:"dropdown",options:[T,F],default:T},bpmMethodFaster:{id:"catjam-webm-bpm-method-faster-songs",label:"Faster Method",type:"dropdown",options:[T,F],default:T},size:{id:"catjam-webm-position-left-size",label:"Left Size (%)",type:"number",default:100}},C=new class{constructor(t,e,n={}){this.name=t,this.settingsId=e,this.initialSettingsFields=n,g(this,"settingsFields",this.initialSettingsFields),g(this,"stopHistoryListener"),g(this,"setRerender",null),g(this,"pushSettings",async()=>{var t,e;for(Object.entries(this.settingsFields).forEach(([t,e])=>{"button"!==e.type&&void 0===this.getFieldValue(t)&&this.setFieldValue(t,e.defaultValue)});!(null==(e=null==(t=null==Spicetify?void 0:Spicetify.Platform)?void 0:t.History)?void 0:e.listen);)await new Promise(t=>setTimeout(t,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(t=>{"/preferences"===t.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()}),g(this,"rerender",()=>{this.setRerender&&this.setRerender(Math.random())}),g(this,"render",async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(t=>setTimeout(t,100))}const t=document.querySelector(".main-view-container__scroll-node-child main div");if(!t)return console.error("[spcr-settings] settings container not found");let e=Array.from(t.children).find(t=>t.id===this.settingsId);e?console.log(e):(e=document.createElement("div"),e.id=this.settingsId,t.appendChild(e)),R.default.render(P.default.createElement(this.FieldsContainer,null),e)}),g(this,"addButton",(t,e,n,i,a)=>{this.settingsFields[t]={type:"button",description:e,value:n,events:d({onClick:i},a)}}),g(this,"addInput",(t,e,n,i,a,r)=>{this.settingsFields[t]={type:"input",description:e,defaultValue:n,inputType:a,events:d({onChange:i},r)}}),g(this,"addHidden",(t,e)=>{this.settingsFields[t]={type:"hidden",defaultValue:e}}),g(this,"addToggle",(t,e,n,i,a)=>{this.settingsFields[t]={type:"toggle",description:e,defaultValue:n,events:d({onChange:i},a)}}),g(this,"addDropDown",(t,e,n,i,a,r)=>{this.settingsFields[t]={type:"dropdown",description:e,defaultValue:n[i],options:n,events:d({onSelect:a},r)}}),g(this,"getFieldValue",t=>{var e;return null==(e=JSON.parse(Spicetify.LocalStorage.get(`${this.settingsId}.${t}`)||"{}"))?void 0:e.value}),g(this,"setFieldValue",(t,e)=>{Spicetify.LocalStorage.set(`${this.settingsId}.${t}`,JSON.stringify({value:e}))}),g(this,"FieldsContainer",()=>{const[t,e]=(0,P.useState)(0);return this.setRerender=e,P.default.createElement("div",{className:"x-settings-section",key:t},P.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([t,e])=>P.default.createElement(this.Field,{nameId:t,field:e})))}),g(this,"Field",t=>{const e=`${this.settingsId}.${t.nameId}`;let n;if(n="button"===t.field.type?t.field.value:this.getFieldValue(t.nameId),"hidden"===t.field.type)return P.default.createElement(P.default.Fragment,null);const[i,a]=(0,P.useState)(n),r=e=>{void 0!==e&&(a(e),this.setFieldValue(t.nameId,e))};return P.default.createElement("div",{className:"x-settings-row"},P.default.createElement("div",{className:"x-settings-firstColumn"},P.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:e},t.field.description||"")),P.default.createElement("div",{className:"x-settings-secondColumn"},"input"===t.field.type?P.default.createElement("input",p(d({className:"x-settings-input",id:e,dir:"ltr",value:i,type:t.field.inputType||"text"},t.field.events),{onChange:e=>{var n;r(e.currentTarget.value);const i=null==(n=t.field.events)?void 0:n.onChange;i&&i(e)}})):"button"===t.field.type?P.default.createElement("span",null,P.default.createElement("button",p(d({id:e,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button"},t.field.events),{onClick:e=>{var n;r();const i=null==(n=t.field.events)?void 0:n.onClick;i&&i(e)},type:"button"}),i)):"toggle"===t.field.type?P.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},P.default.createElement("input",p(d({id:e,className:"x-toggle-input",type:"checkbox",checked:i},t.field.events),{onClick:e=>{var n;r(e.currentTarget.checked);const i=null==(n=t.field.events)?void 0:n.onClick;i&&i(e)}})),P.default.createElement("span",{className:"x-toggle-indicatorWrapper"},P.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===t.field.type?P.default.createElement("select",p(d({className:"main-dropDown-dropDown",id:e},t.field.events),{onChange:e=>{var n;r(t.field.options[e.currentTarget.selectedIndex]);const i=null==(n=t.field.events)?void 0:n.onChange;i&&i(e)}}),t.field.options.map((t,e)=>P.default.createElement("option",{selected:t===i,value:e+1},t))):P.default.createElement(P.default.Fragment,null)))})}}("Cat-Jam Settings","catjam-settings"),B=new Proxy({},{get:(t,e)=>{const n=E[e];if(!n)return;const i=C.getFieldValue(n.id);if(null==i||""===i)return n.default;if("number"===n.type){const t=Number(i);return isNaN(t)?n.default:t}return i}});function A(t,e){var n,i;if(!t||0===t.length)return-60;let a=0,r=t.length-1,s=0;for(;a<=r;){s=a+r>>1;const n=t[s];if(n.start<=e&&n.start+n.duration>e)break;n.start>e?r=s-1:a=s+1}const o=t[s];if(!o)return-60;const l=e-o.start,u=o.loudness_max_time;if(l<u){const t=l/u;return o.loudness_start+t*(o.loudness_max-o.loudness_start)}{const e=(l-u)/(o.duration-u),a=null!=(i=null==(n=t[s+1])?void 0:n.loudness_start)?i:o.loudness_max;return o.loudness_max+e*(a-o.loudness_max)}}function L(t,e,n=6){if(!t||t.length<2)return 0;const i=e-n/2,a=e+n/2,r=t.filter(t=>t.start>=i&&t.start<=a);return r.length<2?0:60/((r[r.length-1].start-r[0].start)/(r.length-1))}function O(t){return Math.max(0,Math.min(1,(t- -60)/60))}var j=null;function I(){return j}function N(t){j=t}async function D(t=200,e=10){var n,i;const a=null==(i=null==(n=Spicetify.Player.data)?void 0:n.item)?void 0:i.uri;if(!a)return null;try{const t=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${a.split(":")[2]}?format=json`,e=await Spicetify.CosmosAsync.get(t);return N(e),e}catch(n){console.warn(`[CAT-JAM] Error fetching detailed analysis: ${n}`);try{const t=await Spicetify.getAudioData();return N(t),t}catch(n){return e>0?(await new Promise(e=>setTimeout(e,t)),D(t,e-1)):null}}}var $={high:.25,medium:.18,low:.1},_=new class{constructor(){this.state={playbackRate:1,currentBeatIndex:-1}}reset(){this.state={playbackRate:1,currentBeatIndex:-1}}update(t,e,n,i="high"){var a,r;if(!(null==(a=null==n?void 0:n.beats)?void 0:a.length))return{playbackRate:1};const s=n.beats,o=null!=(r=$[i])?r:$.high,l=k,u=M;let c=e%l;c<0&&(c=0);let d=-1;for(let e=s.length-1;e>=0;e--)if(s[e].start<=t){d=e;break}const p=this.findNextBeat(t,s);if(!p)return this.state.playbackRate=this.lerp(this.state.playbackRate,1,o),{playbackRate:this.state.playbackRate};const f=p.time-t;if(f<.005)return{playbackRate:this.state.playbackRate};const m=this.getTimeUntilNextDrop(c,u,l)/f,h=Math.max(.75,Math.min(1.35,m));return this.state.playbackRate=this.lerp(this.state.playbackRate,h,o),d!==this.state.currentBeatIndex&&(this.state.currentBeatIndex=d),{playbackRate:this.state.playbackRate}}findNextBeat(t,e){for(let n=0;n<e.length;n++)if(e[n].start>t)return{index:n,time:e[n].start};return null}getTimeUntilNextDrop(t,e,n){for(const n of e)if(n>t)return n-t;return n-t+e[0]}lerp(t,e,n){return t+(e-t)*n}getState(){return d({},this.state)}},z=new class{constructor(){this.frameTimes=[],this.lastFrameTime=0,this.frameCount=0,this.fpsUpdateTime=0,this.currentFPS=60,this.droppedTimestamps=[],this.measurementWindowMs=1e3,this.samplesCount=30}getPerformanceLevel(){return this.currentFPS<30?"low":this.currentFPS<50?"medium":"high"}getMetrics(){return{level:this.getPerformanceLevel(),fps:this.currentFPS,frameTime:this.lastFrameTime,droppedFrames:this.getDroppedFrames(),avgFrameTime:this.getAverageFrameTime()}}measureFrame(){const t=performance.now();if(this.lastFrameTime>0){const e=t-this.lastFrameTime;this.frameTimes.push(e);const n=Math.floor(e/16.67)-1;if(n>0&&e>50)for(let e=0;e<n;e++)this.droppedTimestamps.push(t);this.frameTimes.length>this.samplesCount&&this.frameTimes.shift()}this.lastFrameTime=t,this.frameCount++,t-this.fpsUpdateTime>=this.measurementWindowMs&&(this.currentFPS=1e3*this.frameCount/(t-this.fpsUpdateTime),this.frameCount=0,this.fpsUpdateTime=t)}getAverageFrameTime(){return 0===this.frameTimes.length?16.67:this.frameTimes.reduce((t,e)=>t+e,0)/this.frameTimes.length}getDroppedFrames(){const t=performance.now();return this.droppedTimestamps=this.droppedTimestamps.filter(e=>t-e<this.measurementWindowMs),this.droppedTimestamps.length}getThrottleInterval(){const t=this.getPerformanceLevel();return"low"===t?33.33:"medium"===t?16.67:0}shouldSkipFrame(){const t=this.getThrottleInterval();return 0!==t&&0!==this.frameTimes.length&&this.frameTimes[this.frameTimes.length-1]<t}reset(){this.frameTimes=[],this.lastFrameTime=0,this.frameCount=0,this.fpsUpdateTime=0,this.currentFPS=60,this.droppedTimestamps=[]}},H={maxBufferSize:8,maxAgeMs:100,interpolationThreshold:.02,maxJumpRate:.5,smoothFactor:.6},J=class{constructor(t=H){this.config=t,this.buffer=[],this.lastOutputRate=1,this.lastOutputTime=0}setConfig(t){this.config=t}push(t,e=performance.now()){this.buffer.push({rate:t,timestamp:e});const n=performance.now();for(this.buffer=this.buffer.filter(t=>n-t.timestamp<this.config.maxAgeMs);this.buffer.length>this.config.maxBufferSize;)this.buffer.shift()}getOutput(t=performance.now()){if(0===this.buffer.length)return{rate:this.lastOutputRate,isBuffered:!1,shouldSkip:!1};const e=this.buffer[this.buffer.length-1];if(1===this.buffer.length)return this.applyBufferLogic(e.rate,e.timestamp,t);const n=this.buffer[0];if(t-n.timestamp>this.config.maxAgeMs)return this.buffer.shift(),this.getOutput(t);const i=this.interpolate(n,e,t);return this.applyBufferLogic(i,n.timestamp,t)}interpolate(t,e,n){const i=e.timestamp-t.timestamp;if(i<=0)return e.rate;const a=n-t.timestamp,r=Math.min(1,Math.max(0,a/i));return t.rate+(e.rate-t.rate)*this.easeInOut(r)}easeInOut(t){return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2}applyBufferLogic(t,e,n){const i=Math.abs(t-this.lastOutputRate),a=n-e<50,r=this.buffer.length>1;if(a&&r&&i>this.config.interpolationThreshold){const e=this.lerp(this.lastOutputRate,t,this.config.smoothFactor);return i>this.config.maxJumpRate?{rate:this.lastOutputRate,isBuffered:!0,shouldSkip:!0}:(this.lastOutputRate=e,this.lastOutputTime=n,{rate:e,isBuffered:!0,shouldSkip:!1})}return this.lastOutputRate=t,this.lastOutputTime=n,{rate:t,isBuffered:r,shouldSkip:!1}}lerp(t,e,n){return t+(e-t)*n}clear(){this.buffer=[],this.lastOutputRate=1}getBufferSize(){return this.buffer.length}isStale(t=performance.now()){return 0===this.buffer.length||t-this.buffer[this.buffer.length-1].timestamp>500}},V=new J(H),U=new J({maxBufferSize:6,maxAgeMs:80,interpolationThreshold:.03,maxJumpRate:.4,smoothFactor:.5}),W=new J({maxBufferSize:4,maxAgeMs:60,interpolationThreshold:.05,maxJumpRate:.35,smoothFactor:.4});function q(t){return"low"===t?W:"medium"===t?U:V}var Y=null,X=!1,G=null,K={progressMs:0,perfLevel:"high",workerActive:!1},Q=[],Z=-1;function tt(t){return t.toFixed(3)+"x"}function et(t){return"high"===t?"#4ade80":"medium"===t?"#facc15":"#f87171"}function nt(t,e,n){return`\n\t\t<div style="display: flex; justify-content: space-between; padding: 1px 0;">\n\t\t\t<span style="color: rgba(255,255,255,0.5);">${t}</span>\n\t\t\t<span style="${n?`color: ${n}; font-weight: 600;`:"color: #fff;"}">${e}</span>\n\t\t</div>\n\t`}function it(t){return t?`\n\t\t\t<div style="\n\t\t\t\tmargin: 6px 0 4px;\n\t\t\t\tpadding: 3px 0;\n\t\t\t\tborder-top: 1px solid rgba(255,255,255,0.06);\n\t\t\t\tfont-size: 9px;\n\t\t\t\tcolor: rgba(255,255,255,0.3);\n\t\t\t\tletter-spacing: 1px;\n\t\t\t\ttext-transform: uppercase;\n\t\t\t">${t}</div>\n\t\t`:'<div style="margin: 4px 0; border-top: 1px solid rgba(255,255,255,0.06);"></div>'}function at(){if(!X||!Y)return;const t=Y.querySelector("#catjam-debug-content");t&&(t.innerHTML=function(){var t,e,n,i,a,r,s,o,l,u,c,d,p;const{progressMs:f,perfLevel:m,workerActive:h}=K,g=f/1e3,y=I(),b=ot(),v=z.getMetrics(),x=q(m),w=null!=(t=null==b?void 0:b.playbackRate)?t:1,S=null!=(e=null==b?void 0:b.currentTime)?e:0;let T=-1;if(null==(n=null==y?void 0:y.beats)?void 0:n.length)for(let t=y.beats.length-1;t>=0;t--)if(y.beats[t].start<=g){T=t;break}const F=1e3*function(t){const e=M,n=k;let i=t%n;i<0&&(i+=n);let a=1/0;for(const t of e){const e=Math.abs(i-t),r=n-e;Math.min(e,r)<a&&(a=Math.min(e,r))}return a}(S);(null==(i=null==y?void 0:y.beats)?void 0:i.length)&&T>=0&&T!==Z&&(Z=T,Q.push(F),Q.length>200&&Q.shift());let P=it("PERFORMANCE");if(P+=nt("FPS",v.fps.toFixed(1),et(v.level)),P+=nt("Profile",v.level.toUpperCase(),et(v.level)),P+=nt("Frame Time",v.avgFrameTime.toFixed(1)+"ms"),P+=nt("Dropped Frames",String(v.droppedFrames),v.droppedFrames>10?"#f87171":void 0),P+=nt("Worker",h?"ACTIVE":"MAIN THREAD",h?"#4ade80":"#facc15"),P+=it("SYNC ENGINE"),P+=nt("Actual Rate",tt(w)),void 0!==K.targetRate&&(P+=nt("Target Rate",tt(K.targetRate),"#60a5fa")),P+=nt("Beat Index",String(T)),P+=nt("Beat Drift",`${F.toFixed(1)}ms`,function(t){const e=Math.abs(t);return e<20?"#4ade80":e<50?"#facc15":"#f87171"}(F)),Q.length>0){const t=Q.filter(t=>t<80).length/Q.length*100;P+=nt("Beat Accuracy",`${t.toFixed(1)}% (last ${Q.length})`,t>85?"#4ade80":t>60?"#facc15":t>=30?void 0:"#f87171")}if(P+=it("AUDIO ANALYSIS"),y){const t=null!=(r=null==(a=y.track)?void 0:a.tempo)?r:0,e=L(y.beats,g)||t;P+=nt("Global BPM",t.toFixed(1)),P+=nt("Local BPM",e.toFixed(1),e!==t?"#60a5fa":void 0);const n=A(y.segments,g),i=1+.1499999999999999*O(n);P+=nt("Loudness",n.toFixed(1)+"dB"),P+=nt("Scale",i.toFixed(3)+"x"),P+=nt("Segments",String(null!=(o=null==(s=y.segments)?void 0:s.length)?o:0)),P+=nt("Beats",String(null!=(u=null==(l=y.beats)?void 0:l.length)?u:0))}else P+=nt("Status","No audio data","#f87171");if(P+=it("VIDEO"),b){P+=nt("Video Time",b.currentTime.toFixed(3)+"s"),P+=nt("Paused",b.paused?"YES":"NO",b.paused?"#f87171":"#4ade80");const t=M,e=t.find(t=>t>b.currentTime);P+=nt("Next Head Drop",`in ${(1e3*(e?e-b.currentTime:k-b.currentTime+t[0])).toFixed(0)}ms`)}P+=it("RATE BUFFER"),P+=nt("Buffer Size",`${x.getBufferSize()}`),P+=nt("Stale",x.isStale()?"YES":"NO",x.isStale()?"#f87171":"#4ade80"),P+=it("PLAYBACK");const R=null!=(p=null==(d=null==(c=null==Spicetify?void 0:Spicetify.Player)?void 0:c.getDuration)?void 0:d.call(c))?p:0,E=Math.floor(f/6e4),C=Math.floor(f%6e4/1e3),B=Math.floor(R/6e4),j=Math.floor(R%6e4/1e3);return P+=nt("Progress",`${E}:${String(C).padStart(2,"0")} / ${B}:${String(j).padStart(2,"0")}`),P}()),G=requestAnimationFrame(at)}function rt(t){K=d(d({},K),t)}var st=null;function ot(){return st}function lt(t,e){st&&(Spicetify.Player.isPlaying()?(_.reset(),st.currentTime=0,st.play()):st.pause())}async function ut(){try{const e=B.position===w,n=k,i=`width: ${B.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,a=e?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer",r=e?"width: 65px; height: 65px;":i,s=await async function(t,e=50,n=100){for(let i=0;i<e;i++){const e=document.querySelector(t);if(e)return e;await new Promise(t=>setTimeout(t,n))}throw new Error(`Element ${t} not found.`)}(a);if(st){st.remove();const t=document.getElementById(x);t&&t.remove()}const o=B.link||"https://github.com/FixeQD/spicetify-cat-jam-synced-reborn/raw/main/src/resources/catjam.webm";(st=document.createElement("video")).loop=!1,st.autoplay=!1,st.muted=!0,st.style.cssText=r,st.src=o,st.id=x;const l=n-.15,u=()=>{st&&st.currentTime>=l&&(st.currentTime=0)},c=()=>{st&&(st.currentTime=0,st.play())};st.addEventListener("timeupdate",u),st.addEventListener("ended",c),(t=st).style.pointerEvents="auto",t.addEventListener("click",t=>{t.shiftKey&&(t.preventDefault(),(X=!X)?(Y||(Y=function(){const t=document.createElement("div");return t.id="catjam-debug-overlay",t.style.cssText="\n\t\tposition: fixed;\n\t\ttop: 80px;\n\t\tleft: 20px;\n\t\tz-index: 99999;\n\t\tbackground: rgba(0, 0, 0, 0.88);\n\t\tcolor: #e0e0e0;\n\t\tfont-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'SF Mono', monospace;\n\t\tfont-size: 11px;\n\t\tline-height: 1.55;\n\t\tpadding: 0;\n\t\tborder-radius: 8px;\n\t\tborder: 1px solid rgba(255, 255, 255, 0.08);\n\t\tbackdrop-filter: blur(12px);\n\t\tbox-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n\t\tmin-width: 310px;\n\t\tuser-select: none;\n\t\tcursor: default;\n\t\tpointer-events: auto;\n\t",t.innerHTML='\n\t\t<div id="catjam-debug-header" style="\n\t\t\tpadding: 8px 12px;\n\t\t\tbackground: rgba(255, 255, 255, 0.04);\n\t\t\tborder-bottom: 1px solid rgba(255, 255, 255, 0.06);\n\t\t\tborder-radius: 8px 8px 0 0;\n\t\t\tcursor: grab;\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tjustify-content: space-between;\n\t\t">\n\t\t\t<span style="font-weight: 600; color: #fff; letter-spacing: 0.5px;">\n\t\t\t\tCat Jam Debug\n\t\t\t</span>\n\t\t\t<span style="\n\t\t\t\tfont-size: 9px;\n\t\t\t\tcolor: rgba(255, 255, 255, 0.35);\n\t\t\t\tletter-spacing: 0.3px;\n\t\t\t">v2.5.0 - drag to move</span>\n\t\t</div>\n\t\t<div id="catjam-debug-content" style="padding: 10px 12px;"></div>\n\t',function(t){const e=t.querySelector("#catjam-debug-header");if(!e)return;let n=!1,i=0,a=0;e.addEventListener("mousedown",r=>{0===r.button&&(n=!0,i=r.clientX-t.getBoundingClientRect().left,a=r.clientY-t.getBoundingClientRect().top,e.style.cursor="grabbing",r.preventDefault())}),document.addEventListener("mousemove",e=>{if(!n)return;const r=Math.max(0,Math.min(window.innerWidth-t.offsetWidth,e.clientX-i)),s=Math.max(0,Math.min(window.innerHeight-t.offsetHeight,e.clientY-a));t.style.left=`${r}px`,t.style.top=`${s}px`}),document.addEventListener("mouseup",()=>{n&&(n=!1,e.style.cursor="grab")})}(t),document.body.appendChild(t),t}()),Y.style.display="block",G=requestAnimationFrame(at),console.log("[CAT-JAM] Debug overlay enabled")):(Y&&(Y.style.display="none"),G&&(cancelAnimationFrame(G),G=null),console.log("[CAT-JAM] Debug overlay disabled")))}),await D(),st.playbackRate=1,_.reset(),s.firstChild?s.insertBefore(st,s.firstChild):s.appendChild(st),_.reset(),Spicetify.Player.isPlaying()?st.play():st.pause()}catch(t){console.error("[CAT-JAM] Initialization error: ",t)}var t}async function ct(){var t;for(console.log("[CAT-JAM] Extension initializing...");!(null==(t=null==Spicetify?void 0:Spicetify.Player)?void 0:t.addEventListener)||!(null==Spicetify?void 0:Spicetify.getAudioData);)await new Promise(t=>setTimeout(t,100));Object.values(E).forEach(t=>{"input"===t.type||"number"===t.type?C.addInput(t.id,t.label,String(t.default)):"dropdown"===t.type&&C.addDropDown(t.id,t.label,t.options,0)}),C.addButton("catjam-reload","Reload","Save and reload",()=>{ut()}),C.pushSettings(),await ut();let e=null,n=null,i=!1;try{const t=new Blob([`(${(()=>{const t=M,e=k,n={high:.25,medium:.18,low:.1};let i=1,a=-1;function r(t,e,n){return t+(e-t)*n}self.onmessage=s=>{const{type:o,data:l}=s.data;if("process"===o&&l.audioData){const s=function(s,o,l,u="high"){const c=s/1e3,d=function(s,o,l,u){var c,d;if(!(null==(c=null==l?void 0:l.beats)?void 0:c.length))return 1;const p=l.beats,f=null!=(d=n[u])?d:n.high;let m=o%e;m<0&&(m=0);let h=-1;for(let t=p.length-1;t>=0;t--)if(p[t].start<=s){h=t;break}const g=function(t,e){for(let n=0;n<e.length;n++)if(e[n].start>t)return{index:n,time:e[n].start};return null}(s,p);if(!g)return i=r(i,1,f),i;const y=g.time-s;if(y<.005)return i;const b=function(n){for(const e of t)if(e>n)return e-n;return e-n+t[0]}(m),v=(x=b/y,Math.max(.75,Math.min(1.35,x)));var x;return i=r(i,v,f),h!==a&&(a=h),i}(c,o,l,u),p=function(t,e){var n,i;if(!t||0===t.length)return-60;let a=0,r=t.length-1,s=0;for(;a<=r;){s=a+r>>1;const n=t[s];if(n.start<=e&&n.start+n.duration>e)break;n.start>e?r=s-1:a=s+1}const o=t[s];if(!o)return-60;const l=e-o.start,u=o.loudness_max_time;if(l<u){const t=l/u;return o.loudness_start+t*(o.loudness_max-o.loudness_start)}{const e=(l-u)/(o.duration-u),a=null!=(i=null==(n=t[s+1])?void 0:n.loudness_start)?i:o.loudness_max;return o.loudness_max+e*(a-o.loudness_max)}}(l.segments,c);return{playbackRate:d,scale:1+Math.max(0,Math.min(1,(p+60)/60))*(1.15-1)}}(l.progressMs,l.videoTime,l.audioData,l.perfLevel);self.postMessage({type:"result",data:s})}"resetRate"===o&&(i=1,a=-1)}}).toString()})()`],{type:"application/javascript"});n=new Worker(URL.createObjectURL(t)),i=!0,n.onmessage=t=>{const{type:e,data:n}=t.data;if("result"===e&&ot()){const t=ot(),e=q(z.getPerformanceLevel());e.push(n.playbackRate,performance.now());const i=e.getOutput();i.shouldSkip||(t.playbackRate=i.rate),t.style.transform=`scale(${n.scale})`,rt({targetRate:n.playbackRate})}}}catch(t){console.warn("[CAT-JAM] Worker setup failed, falling back to main thread:",t),n=null}const a=(r=async t=>{var r,s,o;if(!Spicetify.Player.isPlaying())return e=null,void(null==(r=ot())||r.pause());const l=Spicetify.Player.getProgress(),u=z.getPerformanceLevel();if(rt({progressMs:l,perfLevel:u,workerActive:!(!n||!i)}),n&&i){const t=I();if(t){const e=null!=(o=null==(s=ot())?void 0:s.currentTime)?o:0;n.postMessage({type:"process",data:{progressMs:l,audioData:t,perfLevel:u,videoTime:e}})}}else{!function(t,e="high"){if(!st)return;const n=function(t,e="high"){var n;if(!st)return 1;const i=I();if(!(null==(n=null==i?void 0:i.beats)?void 0:n.length))return 1;const a=t/1e3,r=st.currentTime;return _.update(a,r,i,e).playbackRate}(t,e);st.playbackRate=n}(l,u);const{loudness:t}=function(t){var e;if(!j)return{playbackRate:1,loudness:.5};const n=t/1e3,i=B.bpm,a=L(j.beats,n)||(null==(e=j.track)?void 0:e.tempo)||i;return{playbackRate:a/i,loudness:O(A(j.segments,n)),bpm:a}}(l),e=ot();if(e){const n=1+.1499999999999999*t;e.style.transform=`scale(${n})`,rt({targetRate:e.playbackRate})}}e=requestAnimationFrame(a)},t=>{z.measureFrame(),r()});var r;const s=()=>{e||(e=requestAnimationFrame(a))};Spicetify.Player.addEventListener("onplaypause",()=>{Spicetify.Player.getProgress(),lt(performance.now()),Spicetify.Player.isPlaying()?s():(null==n||n.postMessage({type:"resetRate"}),q("high").clear(),q("medium").clear(),q("low").clear())});let o=0;Spicetify.Player.addEventListener("onprogress",()=>{const t=Spicetify.Player.getProgress();Math.abs(t-o)>=3e3&&(lt(performance.now()),null==n||n.postMessage({type:"resetRate"}),q("high").clear(),q("medium").clear(),q("low").clear()),o=t}),Spicetify.Player.addEventListener("songchange",async()=>{var t;const e=ot();if(!e)return;q("high").clear(),q("medium").clear(),q("low").clear(),Q=[],Z=-1;const n=performance.now(),i=await D();if(e.playbackRate=1,null==(t=null==i?void 0:i.beats)?void 0:t.length){const t=i.beats[0].start,e=Math.max(0,1e3*t-(performance.now()-n));setTimeout(()=>{var t;null==(t=ot())||t.play(),s()},e)}else e.play(),s()}),Spicetify.Player.isPlaying()&&s()}var dt,pt=ct;return ct(),dt=v,m(e({},"__esModule",{value:!0}),dt)})();