var e=(()=>{var e=Object.create,t=Object.defineProperty,n=Object.defineProperties,a=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,l=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,c=(e,n,a)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[n]=a,d=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&c(e,n,t[n]);if(r)for(var n of r(t))u.call(t,n)&&c(e,n,t[n]);return e},f=(e,t)=>n(e,s(t)),p=(e,t)=>function(){return t||(0,e[i(e)[0]])((t={exports:{}}).exports,t),t.exports},m=(e,n,s,r)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let l of i(n))o.call(e,l)||l===s||t(e,l,{get:()=>n[l],enumerable:!(r=a(n,l))||r.enumerable});return e},y=(n,a,s)=>(s=null!=n?e(l(n)):{},m(!a&&n&&n.__esModule?s:t(s,"default",{value:n,enumerable:!0}),n)),g=(e,t,n)=>c(e,"symbol"!=typeof t?t+"":t,n),h=p({"spicetify-external:react"(e,t){t.exports=Spicetify.React}}),b=p({"spicetify-external:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),v={};((e,n)=>{for(var a in n)t(e,a,{get:n[a],enumerable:!0})})(v,{default:()=>z});var w="Bottom (Player)",x="Left (Library)",S="Track BPM",P="Advanced",M=[.425,.883,1.403,1.841,2.206,2.664,3.075,3.58,3.945,4.433,4.885,5.292,5.826,6.152,7.06,7.51,8.01,8.435,8.86,9.27],E=y(h()),F=y(b()),C={link:{id:"catjam-webm-link",label:"Custom webM video URL",type:"input",default:""},bpm:{id:"catjam-webm-bpm",label:"Custom default BPM",type:"number",default:135.48},position:{id:"catjam-webm-position",label:"Position",type:"dropdown",options:[w,x],default:w},bpmMethod:{id:"catjam-webm-bpm-method",label:"Lowering Method",type:"dropdown",options:[S,P],default:S},bpmMethodFaster:{id:"catjam-webm-bpm-method-faster-songs",label:"Faster Method",type:"dropdown",options:[S,P],default:S},size:{id:"catjam-webm-position-left-size",label:"Left Size (%)",type:"number",default:100}},j=new class{constructor(e,t,n={}){this.name=e,this.settingsId=t,this.initialSettingsFields=n,g(this,"settingsFields",this.initialSettingsFields),g(this,"stopHistoryListener"),g(this,"setRerender",null),g(this,"pushSettings",async()=>{var e,t;for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!(null==(t=null==(e=null==Spicetify?void 0:Spicetify.Platform)?void 0:e.History)?void 0:t.listen);)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()}),g(this,"rerender",()=>{this.setRerender&&this.setRerender(Math.random())}),g(this,"render",async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}const e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):(t=document.createElement("div"),t.id=this.settingsId,e.appendChild(t)),F.default.render(E.default.createElement(this.FieldsContainer,null),t)}),g(this,"addButton",(e,t,n,a,s)=>{this.settingsFields[e]={type:"button",description:t,value:n,events:d({onClick:a},s)}}),g(this,"addInput",(e,t,n,a,s,i)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:n,inputType:s,events:d({onChange:a},i)}}),g(this,"addHidden",(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}}),g(this,"addToggle",(e,t,n,a,s)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:n,events:d({onChange:a},s)}}),g(this,"addDropDown",(e,t,n,a,s,i)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:n[a],options:n,events:d({onSelect:s},i)}}),g(this,"getFieldValue",e=>{var t;return null==(t=JSON.parse(Spicetify.LocalStorage.get(`${this.settingsId}.${e}`)||"{}"))?void 0:t.value}),g(this,"setFieldValue",(e,t)=>{Spicetify.LocalStorage.set(`${this.settingsId}.${e}`,JSON.stringify({value:t}))}),g(this,"FieldsContainer",()=>{const[e,t]=(0,E.useState)(0);return this.setRerender=t,E.default.createElement("div",{className:"x-settings-section",key:e},E.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>E.default.createElement(this.Field,{nameId:e,field:t})))}),g(this,"Field",e=>{const t=`${this.settingsId}.${e.nameId}`;let n;if(n="button"===e.field.type?e.field.value:this.getFieldValue(e.nameId),"hidden"===e.field.type)return E.default.createElement(E.default.Fragment,null);const[a,s]=(0,E.useState)(n),i=t=>{void 0!==t&&(s(t),this.setFieldValue(e.nameId,t))};return E.default.createElement("div",{className:"x-settings-row"},E.default.createElement("div",{className:"x-settings-firstColumn"},E.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:t},e.field.description||"")),E.default.createElement("div",{className:"x-settings-secondColumn"},"input"===e.field.type?E.default.createElement("input",f(d({className:"x-settings-input",id:t,dir:"ltr",value:a,type:e.field.inputType||"text"},e.field.events),{onChange:t=>{var n;i(t.currentTarget.value);const a=null==(n=e.field.events)?void 0:n.onChange;a&&a(t)}})):"button"===e.field.type?E.default.createElement("span",null,E.default.createElement("button",f(d({id:t,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button"},e.field.events),{onClick:t=>{var n;i();const a=null==(n=e.field.events)?void 0:n.onClick;a&&a(t)},type:"button"}),a)):"toggle"===e.field.type?E.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},E.default.createElement("input",f(d({id:t,className:"x-toggle-input",type:"checkbox",checked:a},e.field.events),{onClick:t=>{var n;i(t.currentTarget.checked);const a=null==(n=e.field.events)?void 0:n.onClick;a&&a(t)}})),E.default.createElement("span",{className:"x-toggle-indicatorWrapper"},E.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===e.field.type?E.default.createElement("select",f(d({className:"main-dropDown-dropDown",id:t},e.field.events),{onChange:t=>{var n;i(e.field.options[t.currentTarget.selectedIndex]);const a=null==(n=e.field.events)?void 0:n.onChange;a&&a(t)}}),e.field.options.map((e,t)=>E.default.createElement("option",{selected:e===a,value:t+1},e))):E.default.createElement(E.default.Fragment,null)))})}}("Cat-Jam Settings","catjam-settings"),k=new Proxy({},{get:(e,t)=>{const n=C[t];if(!n)return;const a=j.getFieldValue(n.id);if(null==a||""===a)return n.default;if("number"===n.type){const e=Number(a);return isNaN(e)?n.default:e}return a}}),T=null;function _(){return T}function O(e){T=e}async function R(e=200,t=10){var n,a;const s=null==(a=null==(n=Spicetify.Player.data)?void 0:n.item)?void 0:a.uri;if(!s)return null;try{const e=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${s.split(":")[2]}?format=json`,t=await Spicetify.CosmosAsync.get(e);return O(t),t}catch(n){console.warn(`[CAT-JAM] Error fetching detailed analysis: ${n}`);try{const e=await Spicetify.getAudioData();return O(e),e}catch(n){return t>0?(await new Promise(t=>setTimeout(t,e)),R(e,t-1)):null}}}var L=null,N=-1,I=1;function D(){return L}function A(e){var t;if(!L)return;const n=_();if(!(null==(t=null==n?void 0:n.beats)?void 0:t.length))return;const a=e/1e3,s=M,i=9.75;let r=0;for(let e=0;e<n.beats.length&&n.beats[e].start<=a;e++)r=e;if(r===N)return;N=r;const l=n.beats[r],o=n.beats[r+1];if(!l||!o)return;const u=o.start-l.start,c=a-l.start,d=Math.min(1,c/u),f=r%s.length,p=s[f],m=s[(f+1)%s.length];let y;y=m>p?m-p:i-p+m;let g=p+d*y;g>=i&&(g-=i);const h=L.currentTime-g,b=Math.abs(h)>4.875?h>0?h-i:h+i:h;Math.abs(b)>1.5?(L.currentTime=g,I=1):Math.abs(b)>.5&&(I=1+(b>0?.1:-.1))}function B(e,t){var n;if(L)if(Spicetify.Player.isPlaying()){N=-1,A(t);const a=t/1e3,s=_();if(null==(n=null==s?void 0:s.beats)?void 0:n.length){const t=s.beats.find(e=>e.start>a);if(t){const n=performance.now()-e,s=Math.max(0,1e3*(t.start-a)-n);setTimeout(()=>{null==L||L.play()},s)}else L.play()}else L.play()}else L.pause()}async function $(){try{const e=k.position===w,t=`width: ${k.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,n=e?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer",a=e?"width: 65px; height: 65px;":t,s=await async function(e,t=50,n=100){for(let a=0;a<t;a++){const t=document.querySelector(e);if(t)return t;await new Promise(e=>setTimeout(e,n))}throw new Error(`Element ${e} not found.`)}(n);L&&L.remove();const i=k.link||"https://github.com/FixeQD/spicetify-cat-jam-synced-reborn/raw/main/src/resources/catjam.webm";(L=document.createElement("video")).loop=!0,L.autoplay=!1,L.muted=!0,L.style.cssText=a,L.src=i,L.id="catjam-webm",await R(),L.playbackRate=1,I=1,s.firstChild?s.insertBefore(L,s.firstChild):s.appendChild(L),N=-1,I=1,Spicetify.Player.isPlaying()?L.play():L.pause()}catch(e){console.error("[CAT-JAM] Initialization error: ",e)}}async function V(){var e;for(console.log("[CAT-JAM] Extension initializing...");!(null==(e=null==Spicetify?void 0:Spicetify.Player)?void 0:e.addEventListener)||!(null==Spicetify?void 0:Spicetify.getAudioData);)await new Promise(e=>setTimeout(e,100));Object.values(C).forEach(e=>{"input"===e.type||"number"===e.type?j.addInput(e.id,e.label,String(e.default)):"dropdown"===e.type&&j.addDropDown(e.id,e.label,e.options,0)}),j.addButton("catjam-reload","Reload","Save and reload",()=>{$()}),j.pushSettings(),await $();let t=null,n=null,a=!1;try{const e=new Blob([`(${(()=>{const e=M;let t=1,n=-1;self.onmessage=a=>{const{type:s,data:i}=a.data;if("process"===s&&i.audioData){const a=function(a,s){const i=a/1e3,r=function(a,s){var i;if(!(null==(i=null==s?void 0:s.beats)?void 0:i.length))return 1;let r=-1;for(let e=0;e<s.beats.length&&s.beats[e].start<=a;e++)r=e;r!==n&&(n=r);const l=function(e,t){for(let n=0;n<t.length;n++)if(t[n].start>e)return{index:n,time:t[n].start};return null}(a,s.beats);if(!l)return 1;const o=l.index%e.length,u=e[o],c=e[(o+1)%e.length];let d;d=c>u?c-u:9.75-u+c;const f=l.time-a;if(f<=.05)return t;const p=d*(f/(s.beats[l.index].start-s.beats[r].start))/f,m=Math.max(.85,Math.min(1.3,p));var y;return t=(y=t)+.08*(m-y),Math.abs(t-m),t}(i,s),l=function(e,t){var n,a;if(!e||0===e.length)return-60;let s=0,i=e.length-1,r=0;for(;s<=i;){r=s+i>>1;const n=e[r];if(n.start<=t&&n.start+n.duration>t)break;n.start>t?i=r-1:s=r+1}const l=e[r];if(!l)return-60;const o=t-l.start,u=l.loudness_max_time;if(o<u){const e=o/u;return l.loudness_start+e*(l.loudness_max-l.loudness_start)}{const t=(o-u)/(l.duration-u),s=null!=(a=null==(n=e[r+1])?void 0:n.loudness_start)?a:l.loudness_max;return l.loudness_max+t*(s-l.loudness_max)}}(s.segments,i);return{playbackRate:r,scale:1+Math.max(0,Math.min(1,(l+60)/60))*(1.15-1)}}(i.progressMs,i.audioData);self.postMessage({type:"result",data:a})}"resetRate"===s&&(t=1,n=-1)}}).toString()})()`],{type:"application/javascript"});n=new Worker(URL.createObjectURL(e)),a=!0,n.onmessage=e=>{const{type:t,data:n}=e.data;if("result"===t&&D()){const e=D();e.playbackRate=n.playbackRate,e.style.transform=`scale(${n.scale})`}}}catch(e){console.warn("[CAT-JAM] Worker setup failed, falling back to main thread:",e),n=null}const s=async()=>{var e;if(!Spicetify.Player.isPlaying())return t=null,void(null==(e=D())||e.pause());const i=Spicetify.Player.getProgress();if(n&&a){const e=_();e&&n.postMessage({type:"process",data:{progressMs:i,audioData:e}})}else{!function(e){if(!L)return;A(e);const t=function(e){var t;if(!L)return 1;const n=_();if(!(null==(t=null==n?void 0:n.beats)?void 0:t.length))return 1;const a=e/1e3,s=L.currentTime,i=function(e,t){for(let n=0;n<t.length;n++)if(t[n].start>e)return{index:n,time:t[n].start};return null}(a,n.beats);if(!i)return 1;const r=function(e){const t=M;for(let n=0;n<t.length;n++)if(t[n]>e)return{index:n,time:t[n]};return{index:0,time:t[0]+9.75}}(s),l=i.time-a;if(l<=.05)return I;let o=r.time-s;o<=0&&(o+=9.75);const u=o/l,c=Math.max(.85,Math.min(1.3,u));var d;return I=(d=I)+.08*(c-d),Math.abs(I-c),I}(e);L.playbackRate=t}(i);const{loudness:e}=function(e){var t;if(!T)return{playbackRate:1,loudness:.5};const n=e/1e3,a=k.bpm,s=function(e,t,n=6){if(!e||e.length<2)return 0;const a=t-n/2,s=t+n/2,i=e.filter(e=>e.start>=a&&e.start<=s);return i.length<2?0:60/((i[i.length-1].start-i[0].start)/(i.length-1))}(T.beats,n)||(null==(t=T.track)?void 0:t.tempo)||a,i=(r=function(e,t){var n,a;if(!e||0===e.length)return-60;let s=0,i=e.length-1,r=0;for(;s<=i;){r=s+i>>1;const n=e[r];if(n.start<=t&&n.start+n.duration>t)break;n.start>t?i=r-1:s=r+1}const l=e[r];if(!l)return-60;const o=t-l.start,u=l.loudness_max_time;if(o<u){const e=o/u;return l.loudness_start+e*(l.loudness_max-l.loudness_start)}{const t=(o-u)/(l.duration-u),s=null!=(a=null==(n=e[r+1])?void 0:n.loudness_start)?a:l.loudness_max;return l.loudness_max+t*(s-l.loudness_max)}}(T.segments,n),Math.max(0,Math.min(1,(r- -60)/60)));var r;return{playbackRate:s/a,loudness:i,bpm:s}}(i),t=D();if(t){const n=1+e*(1.15-1);t.style.transform=`scale(${n})`}}t=requestAnimationFrame(s)},i=()=>{t||(t=requestAnimationFrame(s))};Spicetify.Player.addEventListener("onplaypause",()=>{const e=Spicetify.Player.getProgress();B(performance.now(),e),Spicetify.Player.isPlaying()?i():null==n||n.postMessage({type:"resetRate"})});let r=0;Spicetify.Player.addEventListener("onprogress",()=>{const e=Spicetify.Player.getProgress();Math.abs(e-r)>=500&&B(performance.now(),e),r=e}),Spicetify.Player.addEventListener("songchange",async()=>{var e;const t=D();if(!t)return;const n=performance.now(),a=await R();if(t.playbackRate=1,null==(e=null==a?void 0:a.beats)?void 0:e.length){const e=a.beats[0].start,t=Math.max(0,1e3*e-(performance.now()-n));setTimeout(()=>{var e;null==(e=D())||e.play(),i()},t)}else t.play(),i()}),Spicetify.Player.isPlaying()&&i()}var H,z=V;return V(),H=v,m(t({},"__esModule",{value:!0}),H)})();