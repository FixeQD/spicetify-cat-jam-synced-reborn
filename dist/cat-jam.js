var e=(()=>{var e=Object.create,t=Object.defineProperty,n=Object.defineProperties,i=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,l=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,c=(e,n,i)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i,u=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&c(e,n,t[n]);if(r)for(var n of r(t))d.call(t,n)&&c(e,n,t[n]);return e},p=(e,t)=>n(e,a(t)),f=(e,t)=>function(){return t||(0,e[s(e)[0]])((t={exports:{}}).exports,t),t.exports},m=(e,n,a,r)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let l of s(n))o.call(e,l)||l===a||t(e,l,{get:()=>n[l],enumerable:!(r=i(n,l))||r.enumerable});return e},y=(n,i,a)=>(a=null!=n?e(l(n)):{},m(!i&&n&&n.__esModule?a:t(a,"default",{value:n,enumerable:!0}),n)),g=(e,t,n)=>c(e,"symbol"!=typeof t?t+"":t,n),h=f({"spicetify-external:react"(e,t){t.exports=Spicetify.React}}),b=f({"spicetify-external:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),v={};((e,n)=>{for(var i in n)t(e,i,{get:n[i],enumerable:!0})})(v,{default:()=>H});var w=100,S="Bottom (Player)",P="Left (Library)",x="Track BPM",E="Advanced",C=y(h()),F=y(b()),M={link:{id:"catjam-webm-link",label:"Custom webM video URL",type:"input",default:""},bpm:{id:"catjam-webm-bpm",label:"Custom default BPM",type:"number",default:135.48},position:{id:"catjam-webm-position",label:"Position",type:"dropdown",options:[S,P],default:S},bpmMethod:{id:"catjam-webm-bpm-method",label:"Lowering Method",type:"dropdown",options:[x,E],default:x},bpmMethodFaster:{id:"catjam-webm-bpm-method-faster-songs",label:"Faster Method",type:"dropdown",options:[x,E],default:x},size:{id:"catjam-webm-position-left-size",label:"Left Size (%)",type:"number",default:100}},j=new class{constructor(e,t,n={}){this.name=e,this.settingsId=t,this.initialSettingsFields=n,g(this,"settingsFields",this.initialSettingsFields),g(this,"stopHistoryListener"),g(this,"setRerender",null),g(this,"pushSettings",async()=>{var e,t;for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!(null==(t=null==(e=null==Spicetify?void 0:Spicetify.Platform)?void 0:e.History)?void 0:t.listen);)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()}),g(this,"rerender",()=>{this.setRerender&&this.setRerender(Math.random())}),g(this,"render",async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}const e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):(t=document.createElement("div"),t.id=this.settingsId,e.appendChild(t)),F.default.render(C.default.createElement(this.FieldsContainer,null),t)}),g(this,"addButton",(e,t,n,i,a)=>{this.settingsFields[e]={type:"button",description:t,value:n,events:u({onClick:i},a)}}),g(this,"addInput",(e,t,n,i,a,s)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:n,inputType:a,events:u({onChange:i},s)}}),g(this,"addHidden",(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}}),g(this,"addToggle",(e,t,n,i,a)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:n,events:u({onChange:i},a)}}),g(this,"addDropDown",(e,t,n,i,a,s)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:n[i],options:n,events:u({onSelect:a},s)}}),g(this,"getFieldValue",e=>{var t;return null==(t=JSON.parse(Spicetify.LocalStorage.get(`${this.settingsId}.${e}`)||"{}"))?void 0:t.value}),g(this,"setFieldValue",(e,t)=>{Spicetify.LocalStorage.set(`${this.settingsId}.${e}`,JSON.stringify({value:t}))}),g(this,"FieldsContainer",()=>{const[e,t]=(0,C.useState)(0);return this.setRerender=t,C.default.createElement("div",{className:"x-settings-section",key:e},C.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>C.default.createElement(this.Field,{nameId:e,field:t})))}),g(this,"Field",e=>{const t=`${this.settingsId}.${e.nameId}`;let n;if(n="button"===e.field.type?e.field.value:this.getFieldValue(e.nameId),"hidden"===e.field.type)return C.default.createElement(C.default.Fragment,null);const[i,a]=(0,C.useState)(n),s=t=>{void 0!==t&&(a(t),this.setFieldValue(e.nameId,t))};return C.default.createElement("div",{className:"x-settings-row"},C.default.createElement("div",{className:"x-settings-firstColumn"},C.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:t},e.field.description||"")),C.default.createElement("div",{className:"x-settings-secondColumn"},"input"===e.field.type?C.default.createElement("input",p(u({className:"x-settings-input",id:t,dir:"ltr",value:i,type:e.field.inputType||"text"},e.field.events),{onChange:t=>{var n;s(t.currentTarget.value);const i=null==(n=e.field.events)?void 0:n.onChange;i&&i(t)}})):"button"===e.field.type?C.default.createElement("span",null,C.default.createElement("button",p(u({id:t,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button"},e.field.events),{onClick:t=>{var n;s();const i=null==(n=e.field.events)?void 0:n.onClick;i&&i(t)},type:"button"}),i)):"toggle"===e.field.type?C.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},C.default.createElement("input",p(u({id:t,className:"x-toggle-input",type:"checkbox",checked:i},e.field.events),{onClick:t=>{var n;s(t.currentTarget.checked);const i=null==(n=e.field.events)?void 0:n.onClick;i&&i(t)}})),C.default.createElement("span",{className:"x-toggle-indicatorWrapper"},C.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===e.field.type?C.default.createElement("select",p(u({className:"main-dropDown-dropDown",id:t},e.field.events),{onChange:t=>{var n;s(e.field.options[t.currentTarget.selectedIndex]);const i=null==(n=e.field.events)?void 0:n.onChange;i&&i(t)}}),e.field.options.map((e,t)=>C.default.createElement("option",{selected:e===i,value:t+1},e))):C.default.createElement(C.default.Fragment,null)))})}}("Cat-Jam Settings","catjam-settings"),k=new Proxy({},{get:(e,t)=>{const n=M[t];if(!n)return;const i=j.getFieldValue(n.id);if(null==i||""===i)return n.default;if("number"===n.type){const e=Number(i);return isNaN(e)?n.default:e}return i}}),T=null,N=new Map;function O(e){T=e}async function A(e=200,t=10){var n,i;const a=null==(i=null==(n=Spicetify.Player.data)?void 0:n.item)?void 0:i.uri;if(!a)return null;try{const e=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${a.split(":")[2]}?format=json`,t=await Spicetify.CosmosAsync.get(e);return O(t),t}catch(n){console.warn(`[CAT-JAM] Error fetching detailed analysis: ${n}`);try{const e=await Spicetify.getAudioData();return O(e),e}catch(n){return t>0?(await new Promise(t=>setTimeout(t,e)),A(e,t-1)):null}}}async function I(e){const t=k.bpm;if(null==e?void 0:e.track){const n=e.track.tempo;let i=n;k.bpmMethod!==x&&(i=await async function(e){var t,n,i,a;const s=null==(n=null==(t=Spicetify.Player.data)?void 0:t.item)?void 0:n.uri;if(!s)return e;if(N.has(s)){const t=N.get(s);return L(t.danceability,t.energy,e)}try{const t=s.split(":")[2],n=await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/audio-features/${t}`),r=Math.round(w*(null!=(i=n.danceability)?i:.5)),l=Math.round(w*(null!=(a=n.energy)?a:.5));return N.set(s,{danceability:r,energy:l}),L(r,l,e)}catch(t){return console.error("[CAT-JAM] Audio features error: ",t),e}}(n));const a=i?i/t:1;return console.debug(`[CAT-JAM] Track BPM: ${n}, Effective BPM: ${i}, Playback Rate: ${a}`),a}return console.warn("[CAT-JAM] BPM data not available, using default rate."),1}function L(e,t,n){let i=.9,a=.6,s=.6;const r=e/w,l=t/w,o=n/w;r<.5&&(i*=r),l<.5&&(a*=l),o<.8&&(s=.9);const d=1-i+1-a+s;let c=(0!==d?(r*i+l*a+o*s)/d:o)*w;return isNaN(c)?n:(c=c>n?k.bpmMethodFaster!==x?(c+n)/2:n:Math.max(c,70),isNaN(c)?n:c)}var B=null;function R(){return B}function $(e,t){var n;if(B)if(Spicetify.Player.isPlaying()){const i=t/1e3,a=T;if(null==(n=null==a?void 0:a.beats)?void 0:n.length){const t=a.beats.find(e=>e.start>i);if(t){const n=performance.now()-e,a=Math.max(0,1e3*(t.start-i)-n);setTimeout(()=>{null==B||B.play()},a)}else B.play()}else B.play()}else B.pause()}async function _(){try{const e=k.position===S,t=`width: ${k.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,n=e?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer",i=e?"width: 65px; height: 65px;":t,a=await async function(e,t=50,n=100){for(let i=0;i<t;i++){const t=document.querySelector(e);if(t)return t;await new Promise(e=>setTimeout(e,n))}throw new Error(`Element ${e} not found.`)}(n);B&&B.remove();const s=k.link||"https://github.com/FixeQD/spicetify-cat-jam-synced-reborn/raw/main/src/resources/catjam.webm";(B=document.createElement("video")).loop=!0,B.autoplay=!0,B.muted=!0,B.style.cssText=i,B.src=s,B.id="catjam-webm";const r=await A();B.playbackRate=await I(r),a.firstChild?a.insertBefore(B,a.firstChild):a.appendChild(B),Spicetify.Player.isPlaying()?B.play():B.pause()}catch(e){console.error("[CAT-JAM] Initialization error: ",e)}}async function D(){var e;for(console.log("[CAT-JAM] Extension initializing...");!(null==(e=null==Spicetify?void 0:Spicetify.Player)?void 0:e.addEventListener)||!(null==Spicetify?void 0:Spicetify.getAudioData);)await new Promise(e=>setTimeout(e,100));Object.values(M).forEach(e=>{"input"===e.type||"number"===e.type?j.addInput(e.id,e.label,String(e.default)):"dropdown"===e.type&&j.addDropDown(e.id,e.label,e.options,0)}),j.addButton("catjam-reload","Reload","Save and reload",()=>{_()}),j.pushSettings(),await _();let t=null;const n=async()=>{if(!Spicetify.Player.isPlaying())return void(t=null);performance.now();const e=Spicetify.Player.getProgress(),{playbackRate:i,loudness:a}=function(e){var t;if(!T)return{playbackRate:1,loudness:.5};const n=e/1e3,i=k.bpm,a=function(e,t,n=6){if(!e||e.length<2)return 0;const i=t-n/2,a=t+n/2,s=e.filter(e=>e.start>=i&&e.start<=a);return s.length<2?0:60/((s[s.length-1].start-s[0].start)/(s.length-1))}(T.beats,n)||(null==(t=T.track)?void 0:t.tempo)||i,s=(r=function(e,t){var n,i;if(!e||0===e.length)return-60;let a=0,s=e.length-1,r=0;for(;a<=s;){r=a+s>>1;const n=e[r];if(n.start<=t&&n.start+n.duration>t)break;n.start>t?s=r-1:a=r+1}const l=e[r];if(!l)return-60;const o=t-l.start,d=l.loudness_max_time;if(o<d){const e=o/d;return l.loudness_start+e*(l.loudness_max-l.loudness_start)}{const t=(o-d)/(l.duration-d),a=null!=(i=null==(n=e[r+1])?void 0:n.loudness_start)?i:l.loudness_max;return l.loudness_max+t*(a-l.loudness_max)}}(T.segments,n),Math.max(0,Math.min(1,(r- -60)/60)));var r;return{playbackRate:a/i,loudness:s,bpm:a}}(e),s=R();if(s){s.playbackRate=i;const e=1+a*(1.15-1);s.style.transform=`scale(${e})`}t=requestAnimationFrame(n)},i=()=>{t||(t=requestAnimationFrame(n))};Spicetify.Player.addEventListener("onplaypause",()=>{const e=Spicetify.Player.getProgress();$(performance.now(),e),Spicetify.Player.isPlaying()&&i()});let a=0;Spicetify.Player.addEventListener("onprogress",()=>{const e=Spicetify.Player.getProgress();Math.abs(e-a)>=500&&$(performance.now(),e),a=e}),Spicetify.Player.addEventListener("songchange",async()=>{var e;const t=R();if(!t)return;const n=performance.now(),a=await A();if(t.playbackRate=await I(a),null==(e=null==a?void 0:a.beats)?void 0:e.length){const e=a.beats[0].start,t=Math.max(0,1e3*e-(performance.now()-n));setTimeout(()=>{var e;null==(e=R())||e.play(),i()},t)}else t.play(),i()}),Spicetify.Player.isPlaying()&&i()}var V,H=D;return D(),V=v,m(t({},"__esModule",{value:!0}),V)})();