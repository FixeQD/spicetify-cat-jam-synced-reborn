var e=(()=>{var e=Object.create,t=Object.defineProperty,n=Object.defineProperties,i=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertyNames,l=Object.getOwnPropertySymbols,r=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,c=(e,n,i)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i,u=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&c(e,n,t[n]);if(l)for(var n of l(t))d.call(t,n)&&c(e,n,t[n]);return e},p=(e,t)=>n(e,a(t)),f=(e,t)=>function(){return t||(0,e[s(e)[0]])((t={exports:{}}).exports,t),t.exports},m=(e,n,a,l)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let r of s(n))o.call(e,r)||r===a||t(e,r,{get:()=>n[r],enumerable:!(l=i(n,r))||l.enumerable});return e},y=(n,i,a)=>(a=null!=n?e(r(n)):{},m(!i&&n&&n.__esModule?a:t(a,"default",{value:n,enumerable:!0}),n)),g=(e,t,n)=>c(e,"symbol"!=typeof t?t+"":t,n),h=f({"spicetify-external:react"(e,t){t.exports=Spicetify.React}}),b=f({"spicetify-external:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),v={};((e,n)=>{for(var i in n)t(e,i,{get:n[i],enumerable:!0})})(v,{default:()=>H});var w=100,S="Bottom (Player)",P="Left (Library)",x="Track BPM",E="Advanced",C=y(h()),F=y(b()),j={link:{id:"catjam-webm-link",label:"Custom webM video URL",type:"input",default:""},bpm:{id:"catjam-webm-bpm",label:"Custom default BPM",type:"number",default:135.48},position:{id:"catjam-webm-position",label:"Position",type:"dropdown",options:[S,P],default:S},bpmMethod:{id:"catjam-webm-bpm-method",label:"Lowering Method",type:"dropdown",options:[x,E],default:x},bpmMethodFaster:{id:"catjam-webm-bpm-method-faster-songs",label:"Faster Method",type:"dropdown",options:[x,E],default:x},size:{id:"catjam-webm-position-left-size",label:"Left Size (%)",type:"number",default:100}},M=new class{constructor(e,t,n={}){this.name=e,this.settingsId=t,this.initialSettingsFields=n,g(this,"settingsFields",this.initialSettingsFields),g(this,"stopHistoryListener"),g(this,"setRerender",null),g(this,"pushSettings",async()=>{var e,t;for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!(null==(t=null==(e=null==Spicetify?void 0:Spicetify.Platform)?void 0:e.History)?void 0:t.listen);)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()}),g(this,"rerender",()=>{this.setRerender&&this.setRerender(Math.random())}),g(this,"render",async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}const e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):(t=document.createElement("div"),t.id=this.settingsId,e.appendChild(t)),F.default.render(C.default.createElement(this.FieldsContainer,null),t)}),g(this,"addButton",(e,t,n,i,a)=>{this.settingsFields[e]={type:"button",description:t,value:n,events:u({onClick:i},a)}}),g(this,"addInput",(e,t,n,i,a,s)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:n,inputType:a,events:u({onChange:i},s)}}),g(this,"addHidden",(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}}),g(this,"addToggle",(e,t,n,i,a)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:n,events:u({onChange:i},a)}}),g(this,"addDropDown",(e,t,n,i,a,s)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:n[i],options:n,events:u({onSelect:a},s)}}),g(this,"getFieldValue",e=>{var t;return null==(t=JSON.parse(Spicetify.LocalStorage.get(`${this.settingsId}.${e}`)||"{}"))?void 0:t.value}),g(this,"setFieldValue",(e,t)=>{Spicetify.LocalStorage.set(`${this.settingsId}.${e}`,JSON.stringify({value:t}))}),g(this,"FieldsContainer",()=>{const[e,t]=(0,C.useState)(0);return this.setRerender=t,C.default.createElement("div",{className:"x-settings-section",key:e},C.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>C.default.createElement(this.Field,{nameId:e,field:t})))}),g(this,"Field",e=>{const t=`${this.settingsId}.${e.nameId}`;let n;if(n="button"===e.field.type?e.field.value:this.getFieldValue(e.nameId),"hidden"===e.field.type)return C.default.createElement(C.default.Fragment,null);const[i,a]=(0,C.useState)(n),s=t=>{void 0!==t&&(a(t),this.setFieldValue(e.nameId,t))};return C.default.createElement("div",{className:"x-settings-row"},C.default.createElement("div",{className:"x-settings-firstColumn"},C.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:t},e.field.description||"")),C.default.createElement("div",{className:"x-settings-secondColumn"},"input"===e.field.type?C.default.createElement("input",p(u({className:"x-settings-input",id:t,dir:"ltr",value:i,type:e.field.inputType||"text"},e.field.events),{onChange:t=>{var n;s(t.currentTarget.value);const i=null==(n=e.field.events)?void 0:n.onChange;i&&i(t)}})):"button"===e.field.type?C.default.createElement("span",null,C.default.createElement("button",p(u({id:t,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button"},e.field.events),{onClick:t=>{var n;s();const i=null==(n=e.field.events)?void 0:n.onClick;i&&i(t)},type:"button"}),i)):"toggle"===e.field.type?C.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},C.default.createElement("input",p(u({id:t,className:"x-toggle-input",type:"checkbox",checked:i},e.field.events),{onClick:t=>{var n;s(t.currentTarget.checked);const i=null==(n=e.field.events)?void 0:n.onClick;i&&i(t)}})),C.default.createElement("span",{className:"x-toggle-indicatorWrapper"},C.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===e.field.type?C.default.createElement("select",p(u({className:"main-dropDown-dropDown",id:t},e.field.events),{onChange:t=>{var n;s(e.field.options[t.currentTarget.selectedIndex]);const i=null==(n=e.field.events)?void 0:n.onChange;i&&i(t)}}),e.field.options.map((e,t)=>C.default.createElement("option",{selected:e===i,value:t+1},e))):C.default.createElement(C.default.Fragment,null)))})}}("Cat-Jam Settings","catjam-settings"),N=new Proxy({},{get:(e,t)=>{const n=j[t];if(!n)return;const i=M.getFieldValue(n.id);if(null==i||""===i)return n.default;if("number"===n.type){const e=Number(i);return isNaN(e)?n.default:e}return i}}),O=null,T=new Map;async function k(e=200,t=10){try{const e=await Spicetify.getAudioData();return function(e){O=e}(e),e}catch(n){return"object"==typeof n&&null!==n&&"message"in n&&n.message.includes("Cannot read properties of undefined")&&t>0?(await new Promise(t=>setTimeout(t,e)),k(e,t-1)):(console.warn(`[CAT-JAM] Error fetching audio data: ${n}`),null)}}async function I(e){const t=N.bpm;if(null==e?void 0:e.track){const n=e.track.tempo;let i=n;return N.bpmMethod!==x&&(i=await async function(e){var t,n,i,a;const s=null==(n=null==(t=Spicetify.Player.data)?void 0:t.item)?void 0:n.uri;if(!s)return e;if(T.has(s)){const t=T.get(s);return L(t.danceability,t.energy,e)}try{const t=s.split(":")[2],n=await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/audio-features/${t}`),l=Math.round(w*(null!=(i=n.danceability)?i:.5)),r=Math.round(w*(null!=(a=n.energy)?a:.5));return T.set(s,{danceability:l,energy:r}),L(l,r,e)}catch(t){return console.error("[CAT-JAM] Audio features error: ",t),e}}(n)),i?i/t:1}return console.warn("[CAT-JAM] BPM data not available, using default rate."),1}function L(e,t,n){let i=.9,a=.6,s=.6;const l=e/w,r=t/w,o=n/w;l<.5&&(i*=l),r<.5&&(a*=r),o<.8&&(s=.9);const d=1-i+1-a+s;let c=(0!==d?(l*i+r*a+o*s)/d:o)*w;return isNaN(c)?n:(c=c>n?N.bpmMethodFaster!==x?(c+n)/2:n:Math.max(c,70),isNaN(c)?n:c)}var A=null;function B(){return A}function D(e,t){var n;if(A)if(Spicetify.Player.isPlaying()){const i=t/1e3,a=O;if(null==(n=null==a?void 0:a.beats)?void 0:n.length){const t=a.beats.find(e=>e.start>i);if(t){const n=performance.now()-e,a=Math.max(0,1e3*(t.start-i)-n);setTimeout(()=>{null==A||A.play()},a)}else A.play()}else A.play()}else A.pause()}async function V(){try{const e=N.position===S,t=`width: ${N.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,n=e?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer",i=e?"width: 65px; height: 65px;":t,a=await async function(e,t=50,n=100){for(let i=0;i<t;i++){const t=document.querySelector(e);if(t)return t;await new Promise(e=>setTimeout(e,n))}throw new Error(`Element ${e} not found.`)}(n);A&&A.remove();const s=N.link||"https://github.com/BlafKing/spicetify-cat-jam-synced/raw/main/src/resources/catjam.webm";(A=document.createElement("video")).loop=!0,A.autoplay=!0,A.muted=!0,A.style.cssText=i,A.src=s,A.id="catjam-webm";const l=await k();A.playbackRate=await I(l),a.firstChild?a.insertBefore(A,a.firstChild):a.appendChild(A),Spicetify.Player.isPlaying()?A.play():A.pause()}catch(e){console.error("[CAT-JAM] Initialization error: ",e)}}async function R(){var e;for(console.log("[CAT-JAM] Extension initializing...");!(null==(e=null==Spicetify?void 0:Spicetify.Player)?void 0:e.addEventListener)||!(null==Spicetify?void 0:Spicetify.getAudioData);)await new Promise(e=>setTimeout(e,100));Object.values(j).forEach(e=>{"input"===e.type||"number"===e.type?M.addInput(e.id,e.label,String(e.default)):"dropdown"===e.type&&M.addDropDown(e.id,e.label,e.options,0)}),M.addButton("catjam-reload","Reload","Save and reload",()=>{V()}),M.pushSettings(),await V(),Spicetify.Player.addEventListener("onplaypause",()=>{D(performance.now(),Spicetify.Player.getProgress())});let t=0;Spicetify.Player.addEventListener("onprogress",()=>{const e=Spicetify.Player.getProgress();Math.abs(e-t)>=500&&D(performance.now(),e),t=e}),Spicetify.Player.addEventListener("songchange",async()=>{var e;const t=B();if(!t)return;const n=performance.now(),i=await k();if(t.playbackRate=await I(i),null==(e=null==i?void 0:i.beats)?void 0:e.length){const e=i.beats[0].start,t=Math.max(0,1e3*e-(performance.now()-n));setTimeout(()=>{var e;return null==(e=B())?void 0:e.play()},t)}else t.play()})}var $,H=R;return R(),$=v,m(t({},"__esModule",{value:!0}),$)})();