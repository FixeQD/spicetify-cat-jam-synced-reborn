var t=(()=>{var t=Object.create,e=Object.defineProperty,n=Object.defineProperties,a=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,l=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,c=(t,n,a)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[n]=a,d=(t,e)=>{for(var n in e||(e={}))o.call(e,n)&&c(t,n,e[n]);if(r)for(var n of r(e))u.call(e,n)&&c(t,n,e[n]);return t},p=(t,e)=>n(t,i(e)),m=(t,e)=>function(){return e||(0,t[s(t)[0]])((e={exports:{}}).exports,e),e.exports},f=(t,n,i,r)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let l of s(n))o.call(t,l)||l===i||e(t,l,{get:()=>n[l],enumerable:!(r=a(n,l))||r.enumerable});return t},h=(n,a,i)=>(i=null!=n?t(l(n)):{},f(!a&&n&&n.__esModule?i:e(i,"default",{value:n,enumerable:!0}),n)),g=(t,e,n)=>c(t,"symbol"!=typeof e?e+"":e,n),y=m({"spicetify-external:react"(t,e){e.exports=Spicetify.React}}),b=m({"spicetify-external:react-dom"(t,e){e.exports=Spicetify.ReactDOM}}),v={};((t,n)=>{for(var a in n)e(t,a,{get:n[a],enumerable:!0})})(v,{default:()=>bt});var x="catjam-webm",S=135.48,T="Bottom (Player)",w="Left (Library)",F="Track BPM",M="Advanced",R=[.425,.883,1.403,1.841,2.206,2.664,3.075,3.58,3.945,4.433,4.885,5.292,5.826,6.152,7.06,7.51,8.01,8.435,8.86,9.27],k=9.75,P=h(y()),B=h(b()),C={link:{id:"catjam-webm-link",label:"Custom webM video URL",type:"input",default:""},bpm:{id:"catjam-webm-bpm",label:"Custom default BPM",type:"number",default:S},position:{id:"catjam-webm-position",label:"Position",type:"dropdown",options:[T,w],default:T},bpmMethod:{id:"catjam-webm-bpm-method",label:"Lowering Method",type:"dropdown",options:[F,M],default:F},bpmMethodFaster:{id:"catjam-webm-bpm-method-faster-songs",label:"Faster Method",type:"dropdown",options:[F,M],default:F},size:{id:"catjam-webm-position-left-size",label:"Left Size (%)",type:"number",default:100}},E=new class{constructor(t,e,n={}){this.name=t,this.settingsId=e,this.initialSettingsFields=n,g(this,"settingsFields",this.initialSettingsFields),g(this,"stopHistoryListener"),g(this,"setRerender",null),g(this,"pushSettings",async()=>{var t,e;for(Object.entries(this.settingsFields).forEach(([t,e])=>{"button"!==e.type&&void 0===this.getFieldValue(t)&&this.setFieldValue(t,e.defaultValue)});!(null==(e=null==(t=null==Spicetify?void 0:Spicetify.Platform)?void 0:t.History)?void 0:e.listen);)await new Promise(t=>setTimeout(t,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(t=>{"/preferences"===t.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()}),g(this,"rerender",()=>{this.setRerender&&this.setRerender(Math.random())}),g(this,"render",async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(t=>setTimeout(t,100))}const t=document.querySelector(".main-view-container__scroll-node-child main div");if(!t)return console.error("[spcr-settings] settings container not found");let e=Array.from(t.children).find(t=>t.id===this.settingsId);e?console.log(e):(e=document.createElement("div"),e.id=this.settingsId,t.appendChild(e)),B.default.render(P.default.createElement(this.FieldsContainer,null),e)}),g(this,"addButton",(t,e,n,a,i)=>{this.settingsFields[t]={type:"button",description:e,value:n,events:d({onClick:a},i)}}),g(this,"addInput",(t,e,n,a,i,s)=>{this.settingsFields[t]={type:"input",description:e,defaultValue:n,inputType:i,events:d({onChange:a},s)}}),g(this,"addHidden",(t,e)=>{this.settingsFields[t]={type:"hidden",defaultValue:e}}),g(this,"addToggle",(t,e,n,a,i)=>{this.settingsFields[t]={type:"toggle",description:e,defaultValue:n,events:d({onChange:a},i)}}),g(this,"addDropDown",(t,e,n,a,i,s)=>{this.settingsFields[t]={type:"dropdown",description:e,defaultValue:n[a],options:n,events:d({onSelect:i},s)}}),g(this,"getFieldValue",t=>{var e;return null==(e=JSON.parse(Spicetify.LocalStorage.get(`${this.settingsId}.${t}`)||"{}"))?void 0:e.value}),g(this,"setFieldValue",(t,e)=>{Spicetify.LocalStorage.set(`${this.settingsId}.${t}`,JSON.stringify({value:e}))}),g(this,"FieldsContainer",()=>{const[t,e]=(0,P.useState)(0);return this.setRerender=e,P.default.createElement("div",{className:"x-settings-section",key:t},P.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([t,e])=>P.default.createElement(this.Field,{nameId:t,field:e})))}),g(this,"Field",t=>{const e=`${this.settingsId}.${t.nameId}`;let n;if(n="button"===t.field.type?t.field.value:this.getFieldValue(t.nameId),"hidden"===t.field.type)return P.default.createElement(P.default.Fragment,null);const[a,i]=(0,P.useState)(n),s=e=>{void 0!==e&&(i(e),this.setFieldValue(t.nameId,e))};return P.default.createElement("div",{className:"x-settings-row"},P.default.createElement("div",{className:"x-settings-firstColumn"},P.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:e},t.field.description||"")),P.default.createElement("div",{className:"x-settings-secondColumn"},"input"===t.field.type?P.default.createElement("input",p(d({className:"x-settings-input",id:e,dir:"ltr",value:a,type:t.field.inputType||"text"},t.field.events),{onChange:e=>{var n;s(e.currentTarget.value);const a=null==(n=t.field.events)?void 0:n.onChange;a&&a(e)}})):"button"===t.field.type?P.default.createElement("span",null,P.default.createElement("button",p(d({id:e,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button"},t.field.events),{onClick:e=>{var n;s();const a=null==(n=t.field.events)?void 0:n.onClick;a&&a(e)},type:"button"}),a)):"toggle"===t.field.type?P.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},P.default.createElement("input",p(d({id:e,className:"x-toggle-input",type:"checkbox",checked:a},t.field.events),{onClick:e=>{var n;s(e.currentTarget.checked);const a=null==(n=t.field.events)?void 0:n.onClick;a&&a(e)}})),P.default.createElement("span",{className:"x-toggle-indicatorWrapper"},P.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===t.field.type?P.default.createElement("select",p(d({className:"main-dropDown-dropDown",id:e},t.field.events),{onChange:e=>{var n;s(t.field.options[e.currentTarget.selectedIndex]);const a=null==(n=t.field.events)?void 0:n.onChange;a&&a(e)}}),t.field.options.map((t,e)=>P.default.createElement("option",{selected:t===a,value:e+1},t))):P.default.createElement(P.default.Fragment,null)))})}}("Cat-Jam Settings","catjam-settings"),D=new Proxy({},{get:(t,e)=>{const n=C[e];if(!n)return;const a=E.getFieldValue(n.id);if(null==a||""===a)return n.default;if("number"===n.type){const t=Number(a);return isNaN(t)?n.default:t}return a}});function O(t,e){var n,a;if(!t||0===t.length)return-60;let i=0,s=t.length-1,r=0;for(;i<=s;){r=i+s>>1;const n=t[r];if(n.start<=e&&n.start+n.duration>e)break;n.start>e?s=r-1:i=r+1}const l=t[r];if(!l)return-60;const o=e-l.start,u=l.loudness_max_time;if(o<u){const t=o/u;return l.loudness_start+t*(l.loudness_max-l.loudness_start)}{const e=(o-u)/(l.duration-u),i=null!=(a=null==(n=t[r+1])?void 0:n.loudness_start)?a:l.loudness_max;return l.loudness_max+e*(i-l.loudness_max)}}function A(t,e,n=6){if(!t||t.length<2)return 0;const a=e-n/2,i=e+n/2,s=t.filter(t=>t.start>=a&&t.start<=i);return s.length<2?0:60/((s[s.length-1].start-s[0].start)/(s.length-1))}function L(t){return Math.max(0,Math.min(1,(t- -60)/60))}var j=null;function I(){return j}function N(t){j=t}async function $(t=200,e=10){var n,a;const i=null==(a=null==(n=Spicetify.Player.data)?void 0:n.item)?void 0:a.uri;if(!i)return null;try{const t=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${i.split(":")[2]}?format=json`,e=await Spicetify.CosmosAsync.get(t);return N(e),e}catch(n){console.warn(`[CAT-JAM] Error fetching detailed analysis: ${n}`);try{const t=await Spicetify.getAudioData();return N(t),t}catch(n){return e>0?(await new Promise(e=>setTimeout(e,t)),$(t,e-1)):null}}}var H={high:{lerpFactor:.1,maxDelta:.025,snapThreshold:.04,velocityWeight:.35,maxDriftCorrection:.2,aggressiveSnapThreshold:.02,minStableFrames:3},medium:{lerpFactor:.06,maxDelta:.018,snapThreshold:.06,velocityWeight:.28,maxDriftCorrection:.15,aggressiveSnapThreshold:.03,minStableFrames:4},low:{lerpFactor:.04,maxDelta:.012,snapThreshold:.08,velocityWeight:.22,maxDriftCorrection:.12,aggressiveSnapThreshold:.04,minStableFrames:5}},_=new class{constructor(){this.state={playbackRate:1,currentBeatIndex:-1,lastBeatTime:0,expectedVideoTime:0,drift:0},this.velocityHistory=[],this.velocityHistorySize=5}reset(){this.state={playbackRate:1,currentBeatIndex:-1,lastBeatTime:0,expectedVideoTime:0,drift:0},this.velocityHistory=[]}update(t,e,n,a="high"){var i,s;if(!(null==(i=null==n?void 0:n.beats)?void 0:i.length))return{playbackRate:1,shouldSnap:!1};const r=null!=(s=H[a])?s:H.high,l=n.beats;let o=this.findCurrentBeat(t,l);o<0&&(o=0);const u=this.findNextBeat(t,l);if(!u)return{playbackRate:this.state.playbackRate,shouldSnap:!1};o!==this.state.currentBeatIndex&&this.state.currentBeatIndex>=0&&this.onBeatTransition(o,t,r),this.state.currentBeatIndex=o;const{targetRate:c,timeUntilBeat:d,timeUntilDrop:p}=this.calculateTargetRate(t,e,u,l);if(d<=r.snapThreshold){const n=this.handleBeatSnap(t,e,u,l,o,r);return{playbackRate:n.playbackRate,shouldSnap:n.shouldSnap,snapTime:n.snapTime,needsReset:n.needsReset}}const m=this.calculateVelocityPrediction(c,a),f=this.clampTargetRate(c,r);return this.state.playbackRate=this.smoothTransition(this.state.playbackRate,f,r,m),this.state.drift=this.calculateDrift(e,t,u,l,o),{playbackRate:this.state.playbackRate,shouldSnap:!1}}findCurrentBeat(t,e){for(let n=e.length-1;n>=0;n--)if(e[n].start<=t)return n;return-1}findNextBeat(t,e){for(let n=0;n<e.length;n++)if(e[n].start>t)return{index:n,time:e[n].start};return null}getNextHeadDrop(t){const e=R;for(let n=0;n<e.length;n++)if(e[n]>t)return{index:n,time:e[n]};return{index:0,time:e[0]+9.75}}calculateTargetRate(t,e,n,a){const i=R,s=k,r=this.getNextHeadDrop(e);let l;l=r.time<s?r.time-e:s-e+i[0];const o=this.findCurrentBeat(t,a),u=o>=0&&o<a.length-1?a[o+1].start-a[o].start:1,c=n.time-t,d=l*(c/u);return{targetRate:d>0?d/c:1,timeUntilBeat:c,timeUntilDrop:d}}handleBeatSnap(t,e,n,a,i,s){var r;const l=R,o=k,u=n.index%l.length,c=l[u],d=l[(u+1)%l.length];let p;p=d>c?d-c:o-c+d;const m=c+(t-a[i].start)/p*p,f=m>=o?m-o:m;let h=(e>=o?e-o:e)-f;Math.abs(h)>4.875&&(h=h>0?h-o:h+o);const g=Math.abs(h),y=s.maxDriftCorrection,b=null!=(r=s.aggressiveSnapThreshold)?r:.02;let v=1;if(g>1.5)return this.state.playbackRate=1,{playbackRate:1,shouldSnap:!0,snapTime:f,needsReset:!0};if(g>y){const t=g>b?.15:.1;v=h>0?1-Math.min(g*t,.2):1+Math.min(g*t,.2)}const x=g>y?.25:.15;return this.state.playbackRate=this.lerp(this.state.playbackRate,v,x),{playbackRate:this.clamp(this.state.playbackRate,.85,1.3),shouldSnap:!0,snapTime:f,needsReset:!1}}onBeatTransition(t,e,n){if(this.state.lastBeatTime>0){const t=e-this.state.lastBeatTime;if(t>0){const e=(this.state.playbackRate-1)/t;this.velocityHistory.push(e),this.velocityHistory.length>this.velocityHistorySize&&this.velocityHistory.shift()}}this.state.lastBeatTime=e}calculateVelocityPrediction(t,e){var n;return this.velocityHistory.length<2?0:this.velocityHistory.reduce((t,e)=>t+e,0)/this.velocityHistory.length*(null!=(n=H[e])?n:H.high).velocityWeight}calculateDrift(t,e,n,a,i){const s=R,r=k;if(i<0||i>=a.length)return 0;const l=n.index%s.length,o=s[l],u=s[(l+1)%s.length];let c;c=u>o?u-o:r-o+u;const d=i<a.length-1?a[i+1].start-a[i].start:1,p=e-a[i].start;let m=o+Math.min(1,p/d)*c;return m>=r&&(m-=r),t-m}smoothTransition(t,e,n,a){const i=e+a,s=this.clamp(i,.85,1.3);return this.lerp(t,s,n.lerpFactor)}clampTargetRate(t,e){return this.clamp(t,.85,1.3)}clamp(t,e,n){return Math.max(e,Math.min(n,t))}lerp(t,e,n){return t+(e-t)*n}getState(){return d({},this.state)}},z=new class{constructor(){this.frameTimes=[],this.lastFrameTime=0,this.frameCount=0,this.fpsUpdateTime=0,this.currentFPS=60,this.droppedFrames=0,this.measurementWindowMs=1e3,this.samplesCount=30}getPerformanceLevel(){return this.currentFPS<30?"low":this.currentFPS<50?"medium":"high"}getMetrics(){return{level:this.getPerformanceLevel(),fps:this.currentFPS,frameTime:this.lastFrameTime,droppedFrames:this.droppedFrames,avgFrameTime:this.getAverageFrameTime()}}measureFrame(){const t=performance.now();if(this.lastFrameTime>0){const e=t-this.lastFrameTime;this.frameTimes.push(e),e>33.33&&this.droppedFrames++,this.frameTimes.length>this.samplesCount&&this.frameTimes.shift()}this.lastFrameTime=t,this.frameCount++,t-this.fpsUpdateTime>=this.measurementWindowMs&&(this.currentFPS=1e3*this.frameCount/(t-this.fpsUpdateTime),this.frameCount=0,this.fpsUpdateTime=t)}getAverageFrameTime(){return 0===this.frameTimes.length?16.67:this.frameTimes.reduce((t,e)=>t+e,0)/this.frameTimes.length}getThrottleInterval(){const t=this.getPerformanceLevel();return"low"===t?33.33:"medium"===t?16.67:0}shouldSkipFrame(){const t=this.getThrottleInterval();return 0!==t&&this.lastFrameTime>0&&this.lastFrameTime<t}reset(){this.frameTimes=[],this.lastFrameTime=0,this.frameCount=0,this.fpsUpdateTime=0,this.currentFPS=60,this.droppedFrames=0}},V={maxBufferSize:8,maxAgeMs:100,interpolationThreshold:.02,maxJumpRate:.15,smoothFactor:.3},J=class{constructor(t=V){this.config=t,this.buffer=[],this.lastOutputRate=1,this.lastOutputTime=0}setConfig(t){this.config=t}push(t,e=performance.now()){this.buffer.push({rate:t,timestamp:e});const n=performance.now();for(this.buffer=this.buffer.filter(t=>n-t.timestamp<this.config.maxAgeMs);this.buffer.length>this.config.maxBufferSize;)this.buffer.shift()}getOutput(t=performance.now()){if(0===this.buffer.length)return{rate:this.lastOutputRate,isBuffered:!1,shouldSkip:!1};const e=this.buffer[this.buffer.length-1];if(1===this.buffer.length)return this.applyBufferLogic(e.rate,e.timestamp,t);const n=this.buffer[0];if(t-n.timestamp>this.config.maxAgeMs)return this.buffer.shift(),this.getOutput(t);const a=this.interpolate(n,e,t);return this.applyBufferLogic(a,n.timestamp,t)}interpolate(t,e,n){const a=e.timestamp-t.timestamp;if(a<=0)return e.rate;const i=n-t.timestamp,s=Math.min(1,Math.max(0,i/a));return t.rate+(e.rate-t.rate)*this.easeInOut(s)}easeInOut(t){return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2}applyBufferLogic(t,e,n){const a=Math.abs(t-this.lastOutputRate),i=n-e<50,s=this.buffer.length>1;if(i&&s&&a>this.config.interpolationThreshold){const e=this.lerp(this.lastOutputRate,t,this.config.smoothFactor);return a>this.config.maxJumpRate?{rate:this.lastOutputRate,isBuffered:!0,shouldSkip:!0}:(this.lastOutputRate=e,this.lastOutputTime=n,{rate:e,isBuffered:!0,shouldSkip:!1})}return this.lastOutputRate=t,this.lastOutputTime=n,{rate:t,isBuffered:s,shouldSkip:!1}}lerp(t,e,n){return t+(e-t)*n}clear(){this.buffer=[],this.lastOutputRate=1}getBufferSize(){return this.buffer.length}isStale(t=performance.now()){return 0===this.buffer.length||t-this.lastOutputTime>this.config.maxAgeMs}},U=new J(V),W=new J({maxBufferSize:6,maxAgeMs:80,interpolationThreshold:.03,maxJumpRate:.12,smoothFactor:.25}),q=new J({maxBufferSize:4,maxAgeMs:60,interpolationThreshold:.05,maxJumpRate:.1,smoothFactor:.2});function Y(t){return"low"===t?q:"medium"===t?W:U}var X=null,G=!1,K=null,Q={progressMs:0,perfLevel:"high",workerActive:!1},Z=0,tt=0,et=-1;function nt(t){return t.toFixed(3)+"x"}function at(t){return"high"===t?"#4ade80":"medium"===t?"#facc15":"#f87171"}function it(t,e,n){return`\n\t\t<div style="display: flex; justify-content: space-between; padding: 1px 0;">\n\t\t\t<span style="color: rgba(255,255,255,0.5);">${t}</span>\n\t\t\t<span style="${n?`color: ${n}; font-weight: 600;`:"color: #fff;"}">${e}</span>\n\t\t</div>\n\t`}function st(t){return t?`\n\t\t\t<div style="\n\t\t\t\tmargin: 6px 0 4px;\n\t\t\t\tpadding: 3px 0;\n\t\t\t\tborder-top: 1px solid rgba(255,255,255,0.06);\n\t\t\t\tfont-size: 9px;\n\t\t\t\tcolor: rgba(255,255,255,0.3);\n\t\t\t\tletter-spacing: 1px;\n\t\t\t\ttext-transform: uppercase;\n\t\t\t">${t}</div>\n\t\t`:'<div style="margin: 4px 0; border-top: 1px solid rgba(255,255,255,0.06);"></div>'}var rt=0,lt=0,ot=0,ut=-1,ct=-1;function dt(){if(!G||!X)return;const t=X.querySelector("#catjam-debug-content");t&&(t.innerHTML=function(){var t,e,n,a,i,s,r,l,o,u,c,d,p;const{progressMs:m,perfLevel:f,workerActive:h}=Q,g=m/1e3,y=I(),b=mt(),v=z.getMetrics(),x=Y(f),S=null!=(t=null==b?void 0:b.playbackRate)?t:1,T=null!=(e=null==b?void 0:b.currentTime)?e:0;let w=-1;if(null==(n=null==y?void 0:y.beats)?void 0:n.length)for(let t=y.beats.length-1;t>=0;t--)if(y.beats[t].start<=g){w=t;break}!function(t,e,n){var a,i;if(!(null==(a=null==n?void 0:n.beats)?void 0:a.length))return;const s=R,r=n.beats;let l=-1;for(let t=r.length-1;t>=0;t--)if(r[t].start<=e){l=t;break}l>=0&&l!==ut&&(rt=r[l].start,ut=l);let o=-1;for(let e=s.length-1;e>=0;e--)if(s[e]<=t){o=e;break}if(o>=0&&o!==ct&&(lt=s[o],ct=o,rt>0)){const n=mt(),a=null!=(i=null==n?void 0:n.playbackRate)?i:1;ot=e-(a>0?(t-lt)/a:0)-rt}}(T,g,y);const F=1e3*ot;let M=st("PERFORMANCE");if(M+=it("FPS",v.fps.toFixed(1),at(v.level)),M+=it("Profile",v.level.toUpperCase(),at(v.level)),M+=it("Frame Time",v.avgFrameTime.toFixed(1)+"ms"),M+=it("Dropped Frames",String(v.droppedFrames),v.droppedFrames>10?"#f87171":void 0),M+=it("Worker",h?"ACTIVE":"MAIN THREAD",h?"#4ade80":"#facc15"),M+=st("SYNC ENGINE"),M+=it("Playback Rate",nt(S)),M+=it("Beat Index",String(w)),M+=it("Drift",`${F>=0?"+":""}${F.toFixed(1)}ms`,function(t){const e=Math.abs(t);return e<20?"#4ade80":e<50?"#facc15":"#f87171"}(F)),(null==(a=null==y?void 0:y.beats)?void 0:a.length)&&w>=0){if(w!==et&&(et=w,tt++,Math.abs(F)<50&&Z++,tt>50)){const t=tt-50;tt=50,Z=Math.max(0,Z-t)}const t=tt>0?Z/tt*100:0;M+=it("Beat Accuracy",`${t.toFixed(1)}% (last ${tt})`,t>85?"#4ade80":t>60?"#facc15":"#f87171")}if(M+=st("AUDIO ANALYSIS"),y){const t=null!=(s=null==(i=y.track)?void 0:i.tempo)?s:0,e=A(y.beats,g)||t;M+=it("Global BPM",t.toFixed(1)),M+=it("Local BPM",e.toFixed(1),e!==t?"#60a5fa":void 0);const n=O(y.segments,g),a=1+.1499999999999999*L(n);M+=it("Loudness",n.toFixed(1)+"dB"),M+=it("Scale",a.toFixed(3)+"x"),M+=it("Segments",String(null!=(l=null==(r=y.segments)?void 0:r.length)?l:0)),M+=it("Beats",String(null!=(u=null==(o=y.beats)?void 0:o.length)?u:0))}else M+=it("Status","No audio data","#f87171");if(M+=st("VIDEO"),b){M+=it("Video Time",b.currentTime.toFixed(3)+"s"),M+=it("Video Rate",nt(b.playbackRate)),M+=it("Paused",b.paused?"YES":"NO",b.paused?"#f87171":"#4ade80");const t=R,e=t.find(t=>t>b.currentTime);null!=e||t[0],M+=it("Next Head Drop",`in ${(1e3*(e?e-b.currentTime:k-b.currentTime+t[0])).toFixed(0)}ms`)}M+=st("RATE BUFFER"),M+=it("Buffer Size",`${x.getBufferSize()}`),M+=it("Stale",x.isStale()?"YES":"NO",x.isStale()?"#f87171":"#4ade80"),M+=st("PLAYBACK");const P=null!=(p=null==(d=null==(c=null==Spicetify?void 0:Spicetify.Player)?void 0:c.getDuration)?void 0:d.call(c))?p:0,B=Math.floor(m/6e4),C=Math.floor(m%6e4/1e3),E=Math.floor(P/6e4),D=Math.floor(P%6e4/1e3);return M+=it("Progress",`${B}:${String(C).padStart(2,"0")} / ${E}:${String(D).padStart(2,"0")}`),M}()),K=requestAnimationFrame(dt)}var pt=null;function mt(){return pt}function ft(t,e){var n;if(pt)if(Spicetify.Player.isPlaying()){_.reset();const a=e/1e3,i=I();if(null==(n=null==i?void 0:i.beats)?void 0:n.length){const e=i.beats.find(t=>t.start>a);if(e){const n=performance.now()-t,i=Math.max(0,1e3*(e.start-a)-n);setTimeout(()=>{null==pt||pt.play()},i)}else pt.play()}else pt.play()}else pt.pause()}async function ht(){try{const e=D.position===T,n=k,a=`width: ${D.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,i=e?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer",s=e?"width: 65px; height: 65px;":a,r=await async function(t,e=50,n=100){for(let a=0;a<e;a++){const e=document.querySelector(t);if(e)return e;await new Promise(t=>setTimeout(t,n))}throw new Error(`Element ${t} not found.`)}(i);if(pt){pt.remove();const t=document.getElementById(x);t&&t.remove()}const l=D.link||"https://github.com/FixeQD/spicetify-cat-jam-synced-reborn/raw/main/src/resources/catjam.webm";(pt=document.createElement("video")).loop=!1,pt.autoplay=!1,pt.muted=!0,pt.style.cssText=s,pt.src=l,pt.id=x;const o=n-.15,u=()=>{pt&&pt.currentTime>=o&&(pt.currentTime=0)},c=()=>{pt&&(pt.currentTime=0,pt.play())};pt.addEventListener("timeupdate",u),pt.addEventListener("ended",c),(t=pt).style.pointerEvents="auto",t.addEventListener("click",t=>{t.shiftKey&&(t.preventDefault(),(G=!G)?(X||(X=function(){const t=document.createElement("div");return t.id="catjam-debug-overlay",t.style.cssText="\n\t\tposition: fixed;\n\t\ttop: 80px;\n\t\tleft: 20px;\n\t\tz-index: 99999;\n\t\tbackground: rgba(0, 0, 0, 0.88);\n\t\tcolor: #e0e0e0;\n\t\tfont-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'SF Mono', monospace;\n\t\tfont-size: 11px;\n\t\tline-height: 1.55;\n\t\tpadding: 0;\n\t\tborder-radius: 8px;\n\t\tborder: 1px solid rgba(255, 255, 255, 0.08);\n\t\tbackdrop-filter: blur(12px);\n\t\tbox-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n\t\tmin-width: 310px;\n\t\tuser-select: none;\n\t\tcursor: default;\n\t\tpointer-events: auto;\n\t",t.innerHTML='\n\t\t<div id="catjam-debug-header" style="\n\t\t\tpadding: 8px 12px;\n\t\t\tbackground: rgba(255, 255, 255, 0.04);\n\t\t\tborder-bottom: 1px solid rgba(255, 255, 255, 0.06);\n\t\t\tborder-radius: 8px 8px 0 0;\n\t\t\tcursor: grab;\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tjustify-content: space-between;\n\t\t">\n\t\t\t<span style="font-weight: 600; color: #fff; letter-spacing: 0.5px;">\n\t\t\t\tCat Jam Debug\n\t\t\t</span>\n\t\t\t<span style="\n\t\t\t\tfont-size: 9px;\n\t\t\t\tcolor: rgba(255, 255, 255, 0.35);\n\t\t\t\tletter-spacing: 0.3px;\n\t\t\t">v2.3.0 - drag to move</span>\n\t\t</div>\n\t\t<div id="catjam-debug-content" style="padding: 10px 12px;"></div>\n\t',function(t){const e=t.querySelector("#catjam-debug-header");if(!e)return;let n=!1,a=0,i=0;e.addEventListener("mousedown",s=>{0===s.button&&(n=!0,a=s.clientX-t.getBoundingClientRect().left,i=s.clientY-t.getBoundingClientRect().top,e.style.cursor="grabbing",s.preventDefault())}),document.addEventListener("mousemove",e=>{if(!n)return;const s=Math.max(0,Math.min(window.innerWidth-t.offsetWidth,e.clientX-a)),r=Math.max(0,Math.min(window.innerHeight-t.offsetHeight,e.clientY-i));t.style.left=`${s}px`,t.style.top=`${r}px`}),document.addEventListener("mouseup",()=>{n&&(n=!1,e.style.cursor="grab")})}(t),document.body.appendChild(t),t}()),X.style.display="block",K=requestAnimationFrame(dt),console.log("[CAT-JAM] Debug overlay enabled")):(X&&(X.style.display="none"),K&&(cancelAnimationFrame(K),K=null),console.log("[CAT-JAM] Debug overlay disabled")))}),await $(),pt.playbackRate=1,_.reset(),r.firstChild?r.insertBefore(pt,r.firstChild):r.appendChild(pt),_.reset(),Spicetify.Player.isPlaying()?pt.play():pt.pause()}catch(t){console.error("[CAT-JAM] Initialization error: ",t)}var t}async function gt(){var t;for(console.log("[CAT-JAM] Extension initializing...");!(null==(t=null==Spicetify?void 0:Spicetify.Player)?void 0:t.addEventListener)||!(null==Spicetify?void 0:Spicetify.getAudioData);)await new Promise(t=>setTimeout(t,100));Object.values(C).forEach(t=>{"input"===t.type||"number"===t.type?E.addInput(t.id,t.label,String(t.default)):"dropdown"===t.type&&E.addDropDown(t.id,t.label,t.options,0)}),E.addButton("catjam-reload","Reload","Save and reload",()=>{ht()}),E.pushSettings(),await ht();let e=null,n=null,a=!1;try{const t=new Blob([`(${(()=>{const t=R;let e=1,n=-1;self.onmessage=a=>{const{type:i,data:s}=a.data;if("process"===i&&s.audioData){const a=function(a,i,s="high"){const r=a/1e3,{lerp:l,maxDelta:o}=function(t){return"low"===t?{lerp:.03,maxDelta:.01}:"medium"===t?{lerp:.05,maxDelta:.015}:{lerp:.08,maxDelta:.02}}(s),u=function(a,i,s=.08){var r;if(!(null==(r=null==i?void 0:i.beats)?void 0:r.length))return 1;let l=-1;for(let t=0;t<i.beats.length&&i.beats[t].start<=a;t++)l=t;l!==n&&(n=l);const o=function(t,e){for(let n=0;n<e.length;n++)if(e[n].start>t)return{index:n,time:e[n].start};return null}(a,i.beats);if(!o)return 1;const u=o.index%t.length,c=t[u],d=t[(u+1)%t.length];let p;p=d>c?d-c:9.75-c+d;const m=o.time-a;if(m<=.05)return e;const f=p*(m/(i.beats[o.index].start-i.beats[l].start))/m,h=Math.max(.85,Math.min(1.3,f));return e=(g=e)+(h-g)*s,Math.abs(e-h),e;var g}(r,i,l),c=function(t,e){var n,a;if(!t||0===t.length)return-60;let i=0,s=t.length-1,r=0;for(;i<=s;){r=i+s>>1;const n=t[r];if(n.start<=e&&n.start+n.duration>e)break;n.start>e?s=r-1:i=r+1}const l=t[r];if(!l)return-60;const o=e-l.start,u=l.loudness_max_time;if(o<u){const t=o/u;return l.loudness_start+t*(l.loudness_max-l.loudness_start)}{const e=(o-u)/(l.duration-u),i=null!=(a=null==(n=t[r+1])?void 0:n.loudness_start)?a:l.loudness_max;return l.loudness_max+e*(i-l.loudness_max)}}(i.segments,r);return{playbackRate:u,scale:1+.1499999999999999*Math.max(0,Math.min(1,(c+60)/60))}}(s.progressMs,s.audioData,s.perfLevel);self.postMessage({type:"result",data:a})}"resetRate"===i&&(e=1,n=-1)}}).toString()})()`],{type:"application/javascript"});n=new Worker(URL.createObjectURL(t)),a=!0,n.onmessage=t=>{const{type:e,data:n}=t.data;if("result"===e&&mt()){const t=mt(),e=Y(z.getPerformanceLevel());e.push(n.playbackRate,performance.now());const a=e.getOutput();a.shouldSkip||(t.playbackRate=a.rate),t.style.transform=`scale(${n.scale})`}}}catch(t){console.warn("[CAT-JAM] Worker setup failed, falling back to main thread:",t),n=null}const i=(s=async t=>{var s;if(!Spicetify.Player.isPlaying())return e=null,void(null==(s=mt())||s.pause());const r=Spicetify.Player.getProgress(),l=z.getPerformanceLevel();var o;if(o={progressMs:r,perfLevel:l,workerActive:!(!n||!a)},Q=d(d({},Q),o),n&&a){const t=I();t&&n.postMessage({type:"process",data:{progressMs:r,audioData:t,perfLevel:l}})}else{!function(t,e="high"){if(!pt)return;const n=function(t,e="high"){var n;if(!pt)return 1;const a=I();if(!(null==(n=null==a?void 0:a.beats)?void 0:n.length))return 1;const i=t/1e3,s=pt.currentTime,r=_.update(i,s,a,e);if(r.needsReset){const t=k;if(void 0!==r.snapTime){let e=s;e>=t&&(e-=t);const n=e-r.snapTime;Math.abs(n)>1.5&&(pt.currentTime=r.snapTime)}return _.reset(),1}if(r.shouldSnap&&void 0!==r.snapTime){let t=s;t>=k&&(t-=k);const e=t-r.snapTime;if(Math.abs(e)>1.5)return pt.currentTime=r.snapTime,_.reset(),1}return r.playbackRate}(t,e);pt.playbackRate=n}(r,l);const{loudness:t}=function(t){var e;if(!j)return{playbackRate:1,loudness:.5};const n=t/1e3,a=D.bpm,i=A(j.beats,n)||(null==(e=j.track)?void 0:e.tempo)||a;return{playbackRate:i/a,loudness:L(O(j.segments,n)),bpm:i}}(r),e=mt();if(e){const n=1+.1499999999999999*t;e.style.transform=`scale(${n})`}}e=requestAnimationFrame(i)},t=>{z.measureFrame(),z.shouldSkipFrame()||s()});var s;const r=()=>{e||(e=requestAnimationFrame(i))};Spicetify.Player.addEventListener("onplaypause",()=>{const t=Spicetify.Player.getProgress();ft(performance.now(),t),Spicetify.Player.isPlaying()?r():(null==n||n.postMessage({type:"resetRate"}),Y("high").clear(),Y("medium").clear(),Y("low").clear())});let l=0;Spicetify.Player.addEventListener("onprogress",()=>{const t=Spicetify.Player.getProgress();Math.abs(t-l)>=500&&ft(performance.now(),t),l=t}),Spicetify.Player.addEventListener("songchange",async()=>{var t;const e=mt();if(!e)return;Y("high").clear(),Y("medium").clear(),Y("low").clear();const n=performance.now(),a=await $();if(e.playbackRate=1,null==(t=null==a?void 0:a.beats)?void 0:t.length){const t=a.beats[0].start,e=Math.max(0,1e3*t-(performance.now()-n));setTimeout(()=>{var t;null==(t=mt())||t.play(),r()},e)}else e.play(),r()}),Spicetify.Player.isPlaying()&&r()}var yt,bt=gt;return gt(),yt=v,f(e({},"__esModule",{value:!0}),yt)})();