var e=(()=>{var e=Object.create,t=Object.defineProperty,n=Object.defineProperties,a=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,l=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,d=(e,n,a)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[n]=a,c=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&d(e,n,t[n]);if(r)for(var n of r(t))u.call(t,n)&&d(e,n,t[n]);return e},f=(e,t)=>n(e,i(t)),p=(e,t)=>function(){return t||(0,e[s(e)[0]])((t={exports:{}}).exports,t),t.exports},m=(e,n,i,r)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let l of s(n))o.call(e,l)||l===i||t(e,l,{get:()=>n[l],enumerable:!(r=a(n,l))||r.enumerable});return e},y=(n,a,i)=>(i=null!=n?e(l(n)):{},m(!a&&n&&n.__esModule?i:t(i,"default",{value:n,enumerable:!0}),n)),g=(e,t,n)=>d(e,"symbol"!=typeof t?t+"":t,n),h=p({"spicetify-external:react"(e,t){t.exports=Spicetify.React}}),b=p({"spicetify-external:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),v={};((e,n)=>{for(var a in n)t(e,a,{get:n[a],enumerable:!0})})(v,{default:()=>J});var w="catjam-webm",x="Bottom (Player)",S="Left (Library)",P="Track BPM",E="Advanced",M=[.425,.883,1.403,1.841,2.206,2.664,3.075,3.58,3.945,4.433,4.885,5.292,5.826,6.152,7.06,7.51,8.01,8.435,8.86,9.27],F=y(h()),C=y(b()),j={link:{id:"catjam-webm-link",label:"Custom webM video URL",type:"input",default:""},bpm:{id:"catjam-webm-bpm",label:"Custom default BPM",type:"number",default:135.48},position:{id:"catjam-webm-position",label:"Position",type:"dropdown",options:[x,S],default:x},bpmMethod:{id:"catjam-webm-bpm-method",label:"Lowering Method",type:"dropdown",options:[P,E],default:P},bpmMethodFaster:{id:"catjam-webm-bpm-method-faster-songs",label:"Faster Method",type:"dropdown",options:[P,E],default:P},size:{id:"catjam-webm-position-left-size",label:"Left Size (%)",type:"number",default:100}},k=new class{constructor(e,t,n={}){this.name=e,this.settingsId=t,this.initialSettingsFields=n,g(this,"settingsFields",this.initialSettingsFields),g(this,"stopHistoryListener"),g(this,"setRerender",null),g(this,"pushSettings",async()=>{var e,t;for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!(null==(t=null==(e=null==Spicetify?void 0:Spicetify.Platform)?void 0:e.History)?void 0:t.listen);)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()}),g(this,"rerender",()=>{this.setRerender&&this.setRerender(Math.random())}),g(this,"render",async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}const e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):(t=document.createElement("div"),t.id=this.settingsId,e.appendChild(t)),C.default.render(F.default.createElement(this.FieldsContainer,null),t)}),g(this,"addButton",(e,t,n,a,i)=>{this.settingsFields[e]={type:"button",description:t,value:n,events:c({onClick:a},i)}}),g(this,"addInput",(e,t,n,a,i,s)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:n,inputType:i,events:c({onChange:a},s)}}),g(this,"addHidden",(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}}),g(this,"addToggle",(e,t,n,a,i)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:n,events:c({onChange:a},i)}}),g(this,"addDropDown",(e,t,n,a,i,s)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:n[a],options:n,events:c({onSelect:i},s)}}),g(this,"getFieldValue",e=>{var t;return null==(t=JSON.parse(Spicetify.LocalStorage.get(`${this.settingsId}.${e}`)||"{}"))?void 0:t.value}),g(this,"setFieldValue",(e,t)=>{Spicetify.LocalStorage.set(`${this.settingsId}.${e}`,JSON.stringify({value:t}))}),g(this,"FieldsContainer",()=>{const[e,t]=(0,F.useState)(0);return this.setRerender=t,F.default.createElement("div",{className:"x-settings-section",key:e},F.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>F.default.createElement(this.Field,{nameId:e,field:t})))}),g(this,"Field",e=>{const t=`${this.settingsId}.${e.nameId}`;let n;if(n="button"===e.field.type?e.field.value:this.getFieldValue(e.nameId),"hidden"===e.field.type)return F.default.createElement(F.default.Fragment,null);const[a,i]=(0,F.useState)(n),s=t=>{void 0!==t&&(i(t),this.setFieldValue(e.nameId,t))};return F.default.createElement("div",{className:"x-settings-row"},F.default.createElement("div",{className:"x-settings-firstColumn"},F.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:t},e.field.description||"")),F.default.createElement("div",{className:"x-settings-secondColumn"},"input"===e.field.type?F.default.createElement("input",f(c({className:"x-settings-input",id:t,dir:"ltr",value:a,type:e.field.inputType||"text"},e.field.events),{onChange:t=>{var n;s(t.currentTarget.value);const a=null==(n=e.field.events)?void 0:n.onChange;a&&a(t)}})):"button"===e.field.type?F.default.createElement("span",null,F.default.createElement("button",f(c({id:t,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button"},e.field.events),{onClick:t=>{var n;s();const a=null==(n=e.field.events)?void 0:n.onClick;a&&a(t)},type:"button"}),a)):"toggle"===e.field.type?F.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},F.default.createElement("input",f(c({id:t,className:"x-toggle-input",type:"checkbox",checked:a},e.field.events),{onClick:t=>{var n;s(t.currentTarget.checked);const a=null==(n=e.field.events)?void 0:n.onClick;a&&a(t)}})),F.default.createElement("span",{className:"x-toggle-indicatorWrapper"},F.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===e.field.type?F.default.createElement("select",f(c({className:"main-dropDown-dropDown",id:t},e.field.events),{onChange:t=>{var n;s(e.field.options[t.currentTarget.selectedIndex]);const a=null==(n=e.field.events)?void 0:n.onChange;a&&a(t)}}),e.field.options.map((e,t)=>F.default.createElement("option",{selected:e===a,value:t+1},e))):F.default.createElement(F.default.Fragment,null)))})}}("Cat-Jam Settings","catjam-settings"),T=new Proxy({},{get:(e,t)=>{const n=j[t];if(!n)return;const a=k.getFieldValue(n.id);if(null==a||""===a)return n.default;if("number"===n.type){const e=Number(a);return isNaN(e)?n.default:e}return a}}),_=null;function O(){return _}function L(e){_=e}async function R(e=200,t=10){var n,a;const i=null==(a=null==(n=Spicetify.Player.data)?void 0:n.item)?void 0:a.uri;if(!i)return null;try{const e=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${i.split(":")[2]}?format=json`,t=await Spicetify.CosmosAsync.get(e);return L(t),t}catch(n){console.warn(`[CAT-JAM] Error fetching detailed analysis: ${n}`);try{const e=await Spicetify.getAudioData();return L(e),e}catch(n){return t>0?(await new Promise(t=>setTimeout(t,e)),R(e,t-1)):null}}}var N=null,I=-1,D=1;function A(){return N}function B(e){var t;if(!N)return;const n=O();if(!(null==(t=null==n?void 0:n.beats)?void 0:t.length))return;const a=e/1e3,i=M,s=9.75;let r=0;for(let e=0;e<n.beats.length&&n.beats[e].start<=a;e++)r=e;if(r===I)return;I=r;const l=n.beats[r],o=n.beats[r+1];if(!l||!o)return;const u=o.start-l.start,d=a-l.start,c=Math.min(1,d/u),f=r%i.length,p=i[f],m=i[(f+1)%i.length];let y;y=m>p?m-p:s-p+m;let g=p+c*y;g>=s&&(g-=s);const h=N.currentTime-g,b=Math.abs(h)>4.875?h>0?h-s:h+s:h;Math.abs(b)>1.5?(N.currentTime=g,D=1):Math.abs(b)>.5&&(D=1+(b>0?.1:-.1))}function $(e,t){var n;if(N)if(Spicetify.Player.isPlaying()){I=-1,B(t);const a=t/1e3,i=O();if(null==(n=null==i?void 0:i.beats)?void 0:n.length){const t=i.beats.find(e=>e.start>a);if(t){const n=performance.now()-e,i=Math.max(0,1e3*(t.start-a)-n);setTimeout(()=>{null==N||N.play()},i)}else N.play()}else N.play()}else N.pause()}async function V(){try{const e=T.position===x,t=9.75,n=`width: ${T.size}%; max-width: 300px; height: auto; max-height: 100%; position: absolute; bottom: 0; pointer-events: none; z-index: 1;`,a=e?".main-nowPlayingBar-right":".main-yourLibraryX-libraryItemContainer",i=e?"width: 65px; height: 65px;":n,s=await async function(e,t=50,n=100){for(let a=0;a<t;a++){const t=document.querySelector(e);if(t)return t;await new Promise(e=>setTimeout(e,n))}throw new Error(`Element ${e} not found.`)}(a);if(N){N.remove();const e=document.getElementById(w);e&&e.remove()}const r=T.link||"https://github.com/FixeQD/spicetify-cat-jam-synced-reborn/raw/main/src/resources/catjam.webm";(N=document.createElement("video")).loop=!1,N.autoplay=!1,N.muted=!0,N.style.cssText=i,N.src=r,N.id=w;const l=t-.15,o=()=>{N&&N.currentTime>=l&&(N.currentTime=0)},u=()=>{N&&(N.currentTime=0,N.play())};N.addEventListener("timeupdate",o),N.addEventListener("ended",u),await R(),N.playbackRate=1,D=1,s.firstChild?s.insertBefore(N,s.firstChild):s.appendChild(N),I=-1,D=1,Spicetify.Player.isPlaying()?N.play():N.pause()}catch(e){console.error("[CAT-JAM] Initialization error: ",e)}}async function H(){var e;for(console.log("[CAT-JAM] Extension initializing...");!(null==(e=null==Spicetify?void 0:Spicetify.Player)?void 0:e.addEventListener)||!(null==Spicetify?void 0:Spicetify.getAudioData);)await new Promise(e=>setTimeout(e,100));Object.values(j).forEach(e=>{"input"===e.type||"number"===e.type?k.addInput(e.id,e.label,String(e.default)):"dropdown"===e.type&&k.addDropDown(e.id,e.label,e.options,0)}),k.addButton("catjam-reload","Reload","Save and reload",()=>{V()}),k.pushSettings(),await V();let t=null,n=null,a=!1;try{const e=new Blob([`(${(()=>{const e=M;let t=1,n=-1;self.onmessage=a=>{const{type:i,data:s}=a.data;if("process"===i&&s.audioData){const a=function(a,i){const s=a/1e3,r=function(a,i){var s;if(!(null==(s=null==i?void 0:i.beats)?void 0:s.length))return 1;let r=-1;for(let e=0;e<i.beats.length&&i.beats[e].start<=a;e++)r=e;r!==n&&(n=r);const l=function(e,t){for(let n=0;n<t.length;n++)if(t[n].start>e)return{index:n,time:t[n].start};return null}(a,i.beats);if(!l)return 1;const o=l.index%e.length,u=e[o],d=e[(o+1)%e.length];let c;c=d>u?d-u:9.75-u+d;const f=l.time-a;if(f<=.05)return t;const p=c*(f/(i.beats[l.index].start-i.beats[r].start))/f,m=Math.max(.85,Math.min(1.3,p));var y;return t=(y=t)+.08*(m-y),Math.abs(t-m),t}(s,i),l=function(e,t){var n,a;if(!e||0===e.length)return-60;let i=0,s=e.length-1,r=0;for(;i<=s;){r=i+s>>1;const n=e[r];if(n.start<=t&&n.start+n.duration>t)break;n.start>t?s=r-1:i=r+1}const l=e[r];if(!l)return-60;const o=t-l.start,u=l.loudness_max_time;if(o<u){const e=o/u;return l.loudness_start+e*(l.loudness_max-l.loudness_start)}{const t=(o-u)/(l.duration-u),i=null!=(a=null==(n=e[r+1])?void 0:n.loudness_start)?a:l.loudness_max;return l.loudness_max+t*(i-l.loudness_max)}}(i.segments,s);return{playbackRate:r,scale:1+Math.max(0,Math.min(1,(l+60)/60))*(1.15-1)}}(s.progressMs,s.audioData);self.postMessage({type:"result",data:a})}"resetRate"===i&&(t=1,n=-1)}}).toString()})()`],{type:"application/javascript"});n=new Worker(URL.createObjectURL(e)),a=!0,n.onmessage=e=>{const{type:t,data:n}=e.data;if("result"===t&&A()){const e=A();e.playbackRate=n.playbackRate,e.style.transform=`scale(${n.scale})`}}}catch(e){console.warn("[CAT-JAM] Worker setup failed, falling back to main thread:",e),n=null}const i=async()=>{var e;if(!Spicetify.Player.isPlaying())return t=null,void(null==(e=A())||e.pause());const s=Spicetify.Player.getProgress();if(n&&a){const e=O();e&&n.postMessage({type:"process",data:{progressMs:s,audioData:e}})}else{!function(e){if(!N)return;B(e);const t=function(e){var t;if(!N)return 1;const n=O();if(!(null==(t=null==n?void 0:n.beats)?void 0:t.length))return 1;const a=e/1e3,i=N.currentTime,s=function(e,t){for(let n=0;n<t.length;n++)if(t[n].start>e)return{index:n,time:t[n].start};return null}(a,n.beats);if(!s)return 1;const r=function(e){const t=M;for(let n=0;n<t.length;n++)if(t[n]>e)return{index:n,time:t[n]};return{index:0,time:t[0]+9.75}}(i),l=s.time-a;if(l<=.05)return D;let o=r.time-i;o<=0&&(o+=9.75);const u=o/l,d=Math.max(.85,Math.min(1.3,u));var c;return D=(c=D)+.08*(d-c),Math.abs(D-d),D}(e);N.playbackRate=t}(s);const{loudness:e}=function(e){var t;if(!_)return{playbackRate:1,loudness:.5};const n=e/1e3,a=T.bpm,i=function(e,t,n=6){if(!e||e.length<2)return 0;const a=t-n/2,i=t+n/2,s=e.filter(e=>e.start>=a&&e.start<=i);return s.length<2?0:60/((s[s.length-1].start-s[0].start)/(s.length-1))}(_.beats,n)||(null==(t=_.track)?void 0:t.tempo)||a,s=(r=function(e,t){var n,a;if(!e||0===e.length)return-60;let i=0,s=e.length-1,r=0;for(;i<=s;){r=i+s>>1;const n=e[r];if(n.start<=t&&n.start+n.duration>t)break;n.start>t?s=r-1:i=r+1}const l=e[r];if(!l)return-60;const o=t-l.start,u=l.loudness_max_time;if(o<u){const e=o/u;return l.loudness_start+e*(l.loudness_max-l.loudness_start)}{const t=(o-u)/(l.duration-u),i=null!=(a=null==(n=e[r+1])?void 0:n.loudness_start)?a:l.loudness_max;return l.loudness_max+t*(i-l.loudness_max)}}(_.segments,n),Math.max(0,Math.min(1,(r- -60)/60)));var r;return{playbackRate:i/a,loudness:s,bpm:i}}(s),t=A();if(t){const n=1+e*(1.15-1);t.style.transform=`scale(${n})`}}t=requestAnimationFrame(i)},s=()=>{t||(t=requestAnimationFrame(i))};Spicetify.Player.addEventListener("onplaypause",()=>{const e=Spicetify.Player.getProgress();$(performance.now(),e),Spicetify.Player.isPlaying()?s():null==n||n.postMessage({type:"resetRate"})});let r=0;Spicetify.Player.addEventListener("onprogress",()=>{const e=Spicetify.Player.getProgress();Math.abs(e-r)>=500&&$(performance.now(),e),r=e}),Spicetify.Player.addEventListener("songchange",async()=>{var e;const t=A();if(!t)return;const n=performance.now(),a=await R();if(t.playbackRate=1,null==(e=null==a?void 0:a.beats)?void 0:e.length){const e=a.beats[0].start,t=Math.max(0,1e3*e-(performance.now()-n));setTimeout(()=>{var e;null==(e=A())||e.play(),s()},t)}else t.play(),s()}),Spicetify.Player.isPlaying()&&s()}var z,J=H;return H(),z=v,m(t({},"__esModule",{value:!0}),z)})();